<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>内核虚拟化KVM的使用 | 靖</title><meta name="author" content="靖轩"><meta name="copyright" content="靖轩"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="概念KVM全称为Kernel Virtual Machine内核虚拟机，它是硬件辅助的全虚拟化解决方案，支持x86架构，并已移植到ARM、MIPS、PowerPC等架构。KVM作为可加载的内核模块包含在Linux内核之中，除了通用模块kvm.ko外，针对不同的CPU还有不同的模块，例如针对Intel"><link rel="shortcut icon" href="https://cdn.sujx.net/about/favicon.png"><link rel="canonical" href="https://www.sujx.net/2022/11/03/How2UseKVM/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//hm.baidu.com"/><link rel="preconnect" href="//fonts.googleapis.com" crossorigin=""/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?417b20ac1984432f821159fac27d3bb5";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web&amp;display=swap" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":5,"unescape":false,"languages":{"hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"prismjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  }
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '内核虚拟化KVM的使用',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-05-30 16:30:00'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="靖" type="application/atom+xml">
</head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://cdn.sujx.net/about/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">94</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">179</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">13</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Posts</span></a></div><div class="menus_item"><a class="site-page" href="/books/"><i class="fa-fw fas fa-book-open"></i><span> Books</span></a></div><div class="menus_item"><a class="site-page" href="/movies/"><i class="fa-fw fas fa-tv"></i><span> Movies</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="not-top-img" id="page-header"><nav id="nav"><span id="blog-info"><a href="/" title="靖"><span class="site-name">靖</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> Search</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Posts</span></a></div><div class="menus_item"><a class="site-page" href="/books/"><i class="fa-fw fas fa-book-open"></i><span> Books</span></a></div><div class="menus_item"><a class="site-page" href="/movies/"><i class="fa-fw fas fa-tv"></i><span> Movies</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav></header><main class="layout" id="content-inner"><div id="post"><div id="post-info"><h1 class="post-title">内核虚拟化KVM的使用</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2022-11-03T14:22:22.000Z" title="Created 2022-11-03 22:22:22">2022-11-03</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2023-05-30T08:30:00.011Z" title="Updated 2023-05-30 16:30:00">2023-05-30</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Technology/">Technology</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">Word count:</span><span class="word-count">12.3k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">Reading time:</span><span>58min</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="内核虚拟化KVM的使用"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post View:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div><article class="post-content" id="article-container"><h2 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h2><p><a target="_blank" rel="noopener" href="https://www.linux-kvm.org/">KVM</a>全称为Kernel Virtual Machine内核虚拟机，它是硬件辅助的全虚拟化解决方案，支持x86架构，并已移植到ARM、MIPS、PowerPC等架构。KVM作为可加载的内核模块包含在Linux内核之中，除了通用模块kvm.ko外，针对不同的CPU还有不同的模块，例如针对Intel的CPU的kvm-intel.ko，针对AMD的kvm-amd.ko.</p>
<p>KVM的体系结构的核心是一组实现虚拟化功能的Linux内核模块，包括提供虚拟化能力的kvm.ko，还包括特定CPU的模块和管理中断、时钟等设备管理模块。而其他设备例如网卡、显卡、存储控制器和磁盘则由QEMU(Quick Emulator)来负责。它通过&#x2F;dev&#x2F;kvm接口设置一个Guest操作系统的地址空间，从而提供模拟的I&#x2F;O设备。Libvirt是管理虚拟机和其他虚拟化功能的软件集合，包括API库、守护进程(libvirtd)和其他工具，它在KVM解决方案中扮演管理工具的角色。</p>
<h2 id="入门"><a href="#入门" class="headerlink" title="入门"></a>入门</h2><h3 id="创建虚机"><a href="#创建虚机" class="headerlink" title="创建虚机"></a>创建虚机</h3><h4 id="准备安装"><a href="#准备安装" class="headerlink" title="准备安装"></a>准备安装</h4><p>以Rocky Linux 8为例，需要准备一台对应虚机，并开启相关嵌套虚拟化功能。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 最小虚拟化宿主环境,仅包括libvirt和qemu-kvm</span>
yum group <span class="token function">install</span> <span class="token parameter variable">-y</span> virtualization-hypervisor 
<span class="token comment"># 用于访问和控制虚拟机以及容器的接口，包括libvirt客户端</span>
yum group <span class="token function">install</span> <span class="token parameter variable">-y</span> virtualization-platform 
<span class="token comment"># 离线管理虚拟映像的工具，包括libguestfs和virtio-win</span>
yum group <span class="token function">install</span> <span class="token parameter variable">-y</span> virtualization-tools
systemctl <span class="token function">reboot</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>如果需要图形化桌面管理工具，还需要附加执行以下命令</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 安装桌面</span>
yum group <span class="token function">install</span> <span class="token parameter variable">-y</span> gnome-desktop
<span class="token comment"># 安装管理工具</span>
yum group <span class="token function">install</span> <span class="token parameter variable">-y</span> virtualization-client<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p>安装完成之后，可以进行以下检查</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 查看虚拟机网桥是否建立</span>
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># ifconfig</span>
ens160: <span class="token assign-left variable">flags</span><span class="token operator">=</span><span class="token number">416</span><span class="token operator"><span class="token file-descriptor important">3</span>&lt;</span>UP,BROADCAST,RUNNING,MULTICAST<span class="token operator">></span>  mtu <span class="token number">1500</span>
lo: <span class="token assign-left variable">flags</span><span class="token operator">=</span><span class="token number">7</span><span class="token operator"><span class="token file-descriptor important">3</span>&lt;</span>UP,LOOPBACK,RUNNING<span class="token operator">></span>  mtu <span class="token number">65536</span>
virbr0: <span class="token assign-left variable">flags</span><span class="token operator">=</span><span class="token number">409</span><span class="token operator"><span class="token file-descriptor important">9</span>&lt;</span>UP,BROADCAST,MULTICAST<span class="token operator">></span>  mtu <span class="token number">1500</span>
        inet <span class="token number">192.168</span>.122.1  netmask <span class="token number">255.255</span>.255.0  broadcast <span class="token number">192.168</span>.122.255
        ether <span class="token number">52</span>:54:00:16:e8:45  txqueuelen <span class="token number">1000</span>  <span class="token punctuation">(</span>Ethernet<span class="token punctuation">)</span>
<span class="token comment"># 检查虚拟化后台服务</span>
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># systemctl status libvirtd</span>
● libvirtd.service - Virtualization daemon
   Loaded: loaded <span class="token punctuation">(</span>/usr/lib/systemd/system/libvirtd.service<span class="token punctuation">;</span> enabled<span class="token punctuation">;</span> vendor preset: enabled<span class="token punctuation">)</span>
   Active: active <span class="token punctuation">(</span>running<span class="token punctuation">)</span> since Tue <span class="token number">2023</span>-05-23 <span class="token number">18</span>:33:29 CST<span class="token punctuation">;</span> 24s ago
     Docs: man:libvirtd<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span>
           https://libvirt.org
 Main PID: <span class="token number">1362</span> <span class="token punctuation">(</span>libvirtd<span class="token punctuation">)</span>
<span class="token comment"># 检查CPU特性开启情况</span>
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># egrep '(vmx|svm)' /proc/cpuinfo </span>
flags		<span class="token builtin class-name">:</span> fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush mmx fxsr sse sse2 ss ht syscall nx pdpe1gb rdtscp lm constant_tsc arch_perfmon nopl xtopology tsc_reliable nonstop_tsc cpuid pni pclmulqdq vmx ssse3 fma cx16 pcid sse4_1 sse4_2 x2apic movbe popcnt tsc_deadline_timer aes xsave avx f16c rdrand hypervisor lahf_lm abm 3dnowprefetch cpuid_fault invpcid_single pti ssbd ibrs ibpb stibp tpr_shadow vnmi ept vpid ept_ad fsgsbase tsc_adjust bmi1 avx2 smep bmi2 invpcid rdseed adx smap clflushopt xsaveopt xsavec xgetbv1 xsaves arat md_clear flush_l1d arch_capabilities
<span class="token comment"># 检查虚拟化功能</span>
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># virt-host-validate </span>
  QEMU: Checking <span class="token keyword">for</span> hardware virtualization                                 <span class="token builtin class-name">:</span> PASS
  QEMU: Checking <span class="token keyword">if</span> device /dev/kvm exists                                   <span class="token builtin class-name">:</span> PASS
  QEMU: Checking <span class="token keyword">if</span> device /dev/kvm is accessible                            <span class="token builtin class-name">:</span> PASS
  QEMU: Checking <span class="token keyword">if</span> device /dev/vhost-net exists                             <span class="token builtin class-name">:</span> PASS
  QEMU: Checking <span class="token keyword">if</span> device /dev/net/tun exists                               <span class="token builtin class-name">:</span> PASS
  QEMU: Checking <span class="token keyword">for</span> cgroup <span class="token string">'cpu'</span> controller support                         <span class="token builtin class-name">:</span> PASS
  QEMU: Checking <span class="token keyword">for</span> cgroup <span class="token string">'cpuacct'</span> controller support                     <span class="token builtin class-name">:</span> PASS
  QEMU: Checking <span class="token keyword">for</span> cgroup <span class="token string">'cpuset'</span> controller support                      <span class="token builtin class-name">:</span> PASS
  QEMU: Checking <span class="token keyword">for</span> cgroup <span class="token string">'memory'</span> controller support                      <span class="token builtin class-name">:</span> PASS
  QEMU: Checking <span class="token keyword">for</span> cgroup <span class="token string">'devices'</span> controller support                     <span class="token builtin class-name">:</span> PASS
  QEMU: Checking <span class="token keyword">for</span> cgroup <span class="token string">'blkio'</span> controller support                       <span class="token builtin class-name">:</span> PASS
  QEMU: Checking <span class="token keyword">for</span> device assignment IOMMU support                         <span class="token builtin class-name">:</span> PASS
  QEMU: Checking <span class="token keyword">if</span> IOMMU is enabled by kernel                               <span class="token builtin class-name">:</span> WARN <span class="token punctuation">(</span>IOMMU appears to be disabled <span class="token keyword">in</span> kernel. Add <span class="token assign-left variable">intel_iommu</span><span class="token operator">=</span>on to kernel cmdline arguments<span class="token punctuation">)</span>
  QEMU: Checking <span class="token keyword">for</span> secure guest support                                    <span class="token builtin class-name">:</span> WARN <span class="token punctuation">(</span>Unknown <span class="token keyword">if</span> this platform has Secure Guest support<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>IOMMU(输入输出内存管理单元)可以把设备访问的虚拟地址转化为物理地址。在虚拟化中，开启这个功能后可以启用PCI直通(PCI Passthrough),从而允许虚拟机直接调用主机设备，例如网卡、显卡等。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 在内核启动选项中添加 intel_iommu=on</span>
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># vim /etc/default/grub</span>
<span class="token assign-left variable">GRUB_CMDLINE_LINUX</span><span class="token operator">=</span><span class="token string">"crashkernel=auto resume=/dev/mapper/rl_rocky-swap rd.lvm.lv=rl_rocky/root rd.lvm.lv=rl_rocky/swap intel_iommu=on"</span>
<span class="token comment"># 重新生成引导器配置文件</span>
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># grub2-mkconfig -o /boot/grub2/grub.cfg</span>
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># systemctl reboot</span>
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># virt-host-validate </span>
  QEMU: Checking <span class="token keyword">for</span> hardware virtualization                                 <span class="token builtin class-name">:</span> PASS
  QEMU: Checking <span class="token keyword">if</span> device /dev/kvm exists                                   <span class="token builtin class-name">:</span> PASS
  QEMU: Checking <span class="token keyword">if</span> device /dev/kvm is accessible                            <span class="token builtin class-name">:</span> PASS
  QEMU: Checking <span class="token keyword">if</span> device /dev/vhost-net exists                             <span class="token builtin class-name">:</span> PASS
  QEMU: Checking <span class="token keyword">if</span> device /dev/net/tun exists                               <span class="token builtin class-name">:</span> PASS
  QEMU: Checking <span class="token keyword">for</span> cgroup <span class="token string">'cpu'</span> controller support                         <span class="token builtin class-name">:</span> PASS
  QEMU: Checking <span class="token keyword">for</span> cgroup <span class="token string">'cpuacct'</span> controller support                     <span class="token builtin class-name">:</span> PASS
  QEMU: Checking <span class="token keyword">for</span> cgroup <span class="token string">'cpuset'</span> controller support                      <span class="token builtin class-name">:</span> PASS
  QEMU: Checking <span class="token keyword">for</span> cgroup <span class="token string">'memory'</span> controller support                      <span class="token builtin class-name">:</span> PASS
  QEMU: Checking <span class="token keyword">for</span> cgroup <span class="token string">'devices'</span> controller support                     <span class="token builtin class-name">:</span> PASS
  QEMU: Checking <span class="token keyword">for</span> cgroup <span class="token string">'blkio'</span> controller support                       <span class="token builtin class-name">:</span> PASS
  QEMU: Checking <span class="token keyword">for</span> device assignment IOMMU support                         <span class="token builtin class-name">:</span> PASS
  QEMU: Checking <span class="token keyword">if</span> IOMMU is enabled by kernel                               <span class="token builtin class-name">:</span> PASS<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以使用远程SSH服务直接登录服务器进行管理，或者使用Cockpit这个面板进行管理。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 启用cockpit网页管理终端</span>
yum <span class="token function">install</span> <span class="token parameter variable">-y</span> cockpit cockpit-machines cockpit-session-recording.noarch cockpit-storaged cockpit-pcp
systemctl <span class="token builtin class-name">enable</span> <span class="token parameter variable">--now</span> cockpit.socket<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<h4 id="网页端部署虚机"><a href="#网页端部署虚机" class="headerlink" title="网页端部署虚机"></a>网页端部署虚机</h4><ul>
<li>登录主机的cockpit页面</li>
</ul>
<p><img src="https://cdn.sujx.net/cockpit-index.png" alt="cockpit"></p>
<ul>
<li>查看cockpit的虚拟机管理界面</li>
</ul>
<p><img src="https://cdn.sujx.net/cockpit-virt.png" alt="cockpit-vm"></p>
<ul>
<li>查看虚拟机的网络配置信息</li>
</ul>
<p><img src="https://cdn.sujx.net/cockpit-virt-net.png" alt="vmnet"></p>
<ul>
<li>创建虚机</li>
</ul>
<p><img src="https://cdn.sujx.net/cockpit-virt-config-deploy.png" alt="creatvm"></p>
<ul>
<li>部署虚机</li>
</ul>
<p><img src="https://cdn.sujx.net/cockpit-virt-deploy-centos7.png" alt="install"></p>
<ul>
<li>虚机安装</li>
</ul>
<p><img src="https://cdn.sujx.net/cockpit-virt-deploy-centos7-install.png" alt="deploy"></p>
<h4 id="命令行部署虚机"><a href="#命令行部署虚机" class="headerlink" title="命令行部署虚机"></a>命令行部署虚机</h4><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 查看安装帮助</span>
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># virt-install --help</span>
<span class="token comment"># 查看可用选项 </span>
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># virt-install --option=?</span>
usage: virt-install <span class="token parameter variable">--name</span> NAME <span class="token parameter variable">--memory</span> MB STORAGE INSTALL <span class="token punctuation">[</span>options<span class="token punctuation">]</span>
virt-install: error: unrecognized arguments: <span class="token parameter variable">--option</span><span class="token operator">=</span>?
<span class="token comment"># 查看disk选项的可选值</span>
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># virt-install --disk=?</span>
<span class="token comment"># 查看os-variant支持的版本</span>
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># osinfo-query os |grep centos</span>
 centos-stream8       <span class="token operator">|</span> CentOS Stream <span class="token number">8</span>                                    <span class="token operator">|</span> <span class="token number">8</span>        <span class="token operator">|</span> http://centos.org/centos-stream/8       
 centos-stream9       <span class="token operator">|</span> CentOS Stream <span class="token number">9</span>                                    <span class="token operator">|</span> <span class="token number">9</span>        <span class="token operator">|</span> http://centos.org/centos-stream/9       
 centos7.0            <span class="token operator">|</span> CentOS <span class="token number">7</span>                                           <span class="token operator">|</span> <span class="token number">7</span>        <span class="token operator">|</span> http://centos.org/centos/7.0            
 centos8              <span class="token operator">|</span> CentOS <span class="token number">8</span>                                           <span class="token operator">|</span> <span class="token number">8</span>        <span class="token operator">|</span> http://centos.org/centos/8
 <span class="token comment"># 执行部署</span>
 <span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># virt-install --name centos --memory 1048 --vcpus 1 --disk size=5 --cdrom /var/lib/libvirt/images/CentOS-7-x86_64-Minimal-2009.iso --os-variant centos7.0</span>
WARNING  Unable to connect to graphical console: virt-viewer not installed. Please <span class="token function">install</span> the <span class="token string">'virt-viewer'</span> package.
WARNING  No console to launch <span class="token keyword">for</span> the guest, defaulting to <span class="token parameter variable">--wait</span> <span class="token parameter variable">-1</span>

Starting install<span class="token punctuation">..</span>.
Allocating <span class="token string">'centos.qcow2'</span>                                                                                                                                                                  <span class="token operator">|</span> <span class="token number">5.0</span> GB  00:00:00     

Domain is still running. Installation may be <span class="token keyword">in</span> progress.
Waiting <span class="token keyword">for</span> the installation to complete.
<span class="token comment"># 执行自动化安装</span>
<span class="token comment"># 首先获取先前部署的centos7的anaconda-ks.cfg文件</span>
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># cat ks.cfg </span>
<span class="token comment">#version=DEVEL</span>
<span class="token comment"># System authorization information</span>
auth <span class="token parameter variable">--enableshadow</span> <span class="token parameter variable">--passalgo</span><span class="token operator">=</span>sha512
<span class="token comment"># Use CDROM installation media</span>
cdrom
<span class="token comment"># Use graphical install</span>
graphical
<span class="token comment"># Run the Setup Agent on first boot</span>
firstboot <span class="token parameter variable">--enable</span>
ignoredisk --only-use<span class="token operator">=</span>vda
<span class="token comment"># Keyboard layouts</span>
keyboard <span class="token parameter variable">--vckeymap</span><span class="token operator">=</span>us <span class="token parameter variable">--xlayouts</span><span class="token operator">=</span><span class="token string">'us'</span>
<span class="token comment"># System language</span>
lang en_US.UTF-8 <span class="token parameter variable">--addsupport</span><span class="token operator">=</span>zh_CN.UTF-8

<span class="token comment"># Network information</span>
network  <span class="token parameter variable">--bootproto</span><span class="token operator">=</span>dhcp <span class="token parameter variable">--device</span><span class="token operator">=</span>eth0 <span class="token parameter variable">--ipv6</span><span class="token operator">=</span>auto <span class="token parameter variable">--activate</span>
network  <span class="token parameter variable">--hostname</span><span class="token operator">=</span>guest

<span class="token comment"># Root password</span>
rootpw <span class="token parameter variable">--iscrypted</span> <span class="token variable">$6</span><span class="token variable">$fXDkAKiYiFm45WVl</span><span class="token variable">$y4aKkyg3WrG</span>/Kr9V2zmudjiteXLi8omfkIWob4QHlI2M6EflNlUDkeGL2dTsN6fPL7GiPbtSj81D2iXZmKFg6/
<span class="token comment"># System services</span>
services <span class="token parameter variable">--disabled</span><span class="token operator">=</span><span class="token string">"chronyd"</span>
<span class="token comment"># System timezone</span>
timezone Asia/Shanghai <span class="token parameter variable">--isUtc</span> <span class="token parameter variable">--nontp</span>
user <span class="token parameter variable">--groups</span><span class="token operator">=</span>wheel <span class="token parameter variable">--name</span><span class="token operator">=</span>sujx <span class="token parameter variable">--password</span><span class="token operator">=</span><span class="token variable">$6</span><span class="token variable">$O53JLC0</span>/ED1zlRAT<span class="token variable">$6uMXZclHzYezzmuy</span>.NrK7Hx2olv1IfRp949/kNlguE8g.zDIcAqZpacF1tSnQLMOVWCoY7fKai9aWli/Qqf.Z0 <span class="token parameter variable">--iscrypted</span> <span class="token parameter variable">--gecos</span><span class="token operator">=</span><span class="token string">"sujx"</span>
<span class="token comment"># System bootloader configuration</span>
bootloader <span class="token parameter variable">--append</span><span class="token operator">=</span><span class="token string">" crashkernel=auto console=ttyS0,115200"</span>" <span class="token parameter variable">--location</span><span class="token operator">=</span>mbr --boot-drive<span class="token operator">=</span>vda
autopart <span class="token parameter variable">--type</span><span class="token operator">=</span>lvm
<span class="token comment"># Partition clearing information</span>
clearpart <span class="token parameter variable">--none</span> <span class="token parameter variable">--initlabel</span>
<span class="token comment"># SeLinuxConfig</span>
seLinux <span class="token parameter variable">--disabled</span>

%packages
@^minimal
@core
kexec-tools
<span class="token function">wget</span>
telnet
sysstat
qemu-guest-agent
services <span class="token parameter variable">--enable</span> serial-getty@ttyS0.service,qemu-guest-agent

%end

%addon com_redhat_kdump <span class="token parameter variable">--enable</span> --reserve-mb<span class="token operator">=</span><span class="token string">'auto'</span>

%end

%anaconda
pwpolicy root <span class="token parameter variable">--minlen</span><span class="token operator">=</span><span class="token number">6</span> <span class="token parameter variable">--minquality</span><span class="token operator">=</span><span class="token number">1</span> <span class="token parameter variable">--notstrict</span> <span class="token parameter variable">--nochanges</span> <span class="token parameter variable">--notempty</span>
pwpolicy user <span class="token parameter variable">--minlen</span><span class="token operator">=</span><span class="token number">6</span> <span class="token parameter variable">--minquality</span><span class="token operator">=</span><span class="token number">1</span> <span class="token parameter variable">--notstrict</span> <span class="token parameter variable">--nochanges</span> <span class="token parameter variable">--emptyok</span>
pwpolicy luks <span class="token parameter variable">--minlen</span><span class="token operator">=</span><span class="token number">6</span> <span class="token parameter variable">--minquality</span><span class="token operator">=</span><span class="token number">1</span> <span class="token parameter variable">--notstrict</span> <span class="token parameter variable">--nochanges</span> <span class="token parameter variable">--notempty</span>
%end
<span class="token comment"># 调用kickstart文件进行自动化部署，需要注意的是原来的部署源要从cdrom修改为location，并配置kernel地址。</span>
<span class="token comment"># 如果在ks文件中不修改kernel配置，则还可以使用cdrom参数</span>
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># virt-install --name centos --memory 1048 --vcpus 1 --disk size=5 --location /var/lib/libvirt/images/CentOS-7-x86_64-Minimal-2009.iso,initrd=isolinux/initrd.img,kernel=isolinux/vmlinuz --os-variant centos7.0 --initrd-inject /root/ks.cfg --extra-args ="ks=file:/ks.cfg"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="管理虚机"><a href="#管理虚机" class="headerlink" title="管理虚机"></a>管理虚机</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># virsh 是管理KVM最主要的工具.</span>
<span class="token comment"># 查看虚机清单</span>
<span class="token punctuation">[</span>root@kvm1 images<span class="token punctuation">]</span><span class="token comment"># virsh list --all</span>
 Id   Name      State
-------------------------
 <span class="token number">2</span>    centos7   running
<span class="token comment"># 查看虚机信息,使用虚机ID或者Name均可</span>
<span class="token punctuation">[</span>root@kvm1 images<span class="token punctuation">]</span><span class="token comment"># virsh dominfo 2</span>
Id:             <span class="token number">2</span>
Name:           centos7
UUID:           8a6e60ff-d005-4b86-943f-566ea5de2164
OS Type:        hvm
State:          running
CPU<span class="token punctuation">(</span>s<span class="token punctuation">)</span>:         <span class="token number">2</span>
CPU time:       <span class="token number">33</span>.2s
Max memory:     <span class="token number">1048576</span> KiB
Used memory:    <span class="token number">1048576</span> KiB
Persistent:     <span class="token function">yes</span>
Autostart:      disable
Managed save:   no
Security model: none
Security DOI:   <span class="token number">0</span>
<span class="token comment"># 查看虚机IP地址</span>
<span class="token punctuation">[</span>root@kvm1 images<span class="token punctuation">]</span><span class="token comment"># virsh domifaddr centos7</span>
 Name       MAC address          Protocol     Address
-------------------------------------------------------------------------------
 vnet1      <span class="token number">52</span>:54:00:68:0d:79    ipv4         <span class="token number">192.168</span>.122.242/24
<span class="token comment"># 查看虚拟磁盘信息</span>
<span class="token punctuation">[</span>root@kvm1 images<span class="token punctuation">]</span><span class="token comment"># virsh domblklist centos7</span>
 Target   Source
-------------------------------------------------
 vda      /var/lib/libvirt/images/centos7.qcow2
 sda      -
<span class="token comment"># 查看默认存储池中的内容 </span>
<span class="token punctuation">[</span>root@kvm1 images<span class="token punctuation">]</span><span class="token comment"># virsh vol-list default</span>
 Name                               Path
----------------------------------------------------------------------------------------------
 CentOS-7-x86_64-Minimal-2009.iso   /var/lib/libvirt/images/CentOS-7-x86_64-Minimal-2009.iso
 centos7.qcow2                      /var/lib/libvirt/images/centos7.qcow2
<span class="token comment"># 查看系统的存储池</span>
<span class="token punctuation">[</span>root@kvm1 images<span class="token punctuation">]</span><span class="token comment"># virsh pool-list</span>
 Name      State    Autostart
-------------------------------
 default   active   <span class="token function">yes</span>
 KVM       active   <span class="token function">yes</span>
<span class="token comment"># 创建虚机之后的网卡变化，多出来一个类型为tun的vnet1</span>
<span class="token punctuation">[</span>root@kvm1 images<span class="token punctuation">]</span><span class="token comment"># nmcli c show</span>
NAME    UUID                                  TYPE      DEVICE 
ens160  b2aeba94-95b0-4944-ac7b-c20e3fc15bd0  ethernet  ens160 
virbr0  87574d83-cd4d-4579-b6e7-2c14827af7a0  bridge    virbr0 
vnet1   87aa11ea-4e07-4d29-bc9b-83a981ae2f79  tun       vnet1
<span class="token comment"># 安装QemuGuestAgent</span>
<span class="token comment"># QemuGuestAgent是KVM-QEMU平台上类似VMTools的工具，基于虚拟的串口控制器与主机进行通信</span>
<span class="token punctuation">[</span>root@guest ~<span class="token punctuation">]</span><span class="token comment"># yum install -y qemu-guest-agent</span>
<span class="token punctuation">[</span>root@guest ~<span class="token punctuation">]</span><span class="token comment"># systemctl enable --now qemu-guest-agent</span>
<span class="token comment"># 安装完成上述插件后，就可以有更多的控制选项</span>
<span class="token comment"># 查看虚机挂载情况</span>
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># virsh domfsinfo centos7</span>
 Mountpoint   Name   Type   Target
------------------------------------
 /            dm-0   xfs    vda
 /boot        vda1   xfs    vda
<span class="token comment"># 使用virsh console来登录虚机</span>
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># virsh console 2</span>
<span class="token comment"># 默认安装虚机会出现卡住的情况</span>
<span class="token comment"># 需要进入虚机中，编辑 /etc/default/grub 文件，找到下面行： </span>
<span class="token assign-left variable">GRUB_CMDLINE_LINUX</span><span class="token operator">=</span><span class="token string">"crashkernel=auto rd.lvm.lv=cl/root rd.lvm.lv=cl/swap rhgb quiet” 
改为：（尾部增加 console=ttyS0,115200） 
GRUB_CMDLINE_LINUX="</span><span class="token assign-left variable">crashkernel</span><span class="token operator">=</span>auto <span class="token assign-left variable">rd.lvm.lv</span><span class="token operator">=</span>centos/root <span class="token assign-left variable">rd.lvm.lv</span><span class="token operator">=</span>centos/swap <span class="token assign-left variable">console</span><span class="token operator">=</span>ttyS0,115200"
<span class="token comment"># 重新生成GRUB配置并更新内核参数</span>
grub2-mkconfig <span class="token parameter variable">-o</span> /boot/grub2/grub.cfg
<span class="token comment"># 使用以下命令激活服务</span>
systemctl <span class="token builtin class-name">enable</span> <span class="token parameter variable">--now</span> serial-getty@ttyS0.service

<span class="token comment"># 关闭虚机</span>
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># virsh shutdown centos7</span>
Domain <span class="token string">'centos7'</span> is being <span class="token function">shutdown</span>
<span class="token comment"># 指定--mode配置关机模式，有acpi\agent\initctl\signal\paravirt多个选项，建议在安装和启动qemu-guest-agent服务后搭配agent参数使用</span>
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># virsh shutdown centos7 --mode agent</span>
Domain <span class="token string">'centos7'</span> is being <span class="token function">shutdown</span>
<span class="token comment"># 启动虚机</span>
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># virsh start centos7</span>
Domain <span class="token string">'centos7'</span> started
<span class="token comment"># 虚机拔电</span>
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># virsh destroy centos7</span>
Domain <span class="token string">'centos7'</span> destroyed
<span class="token comment"># 挂起（暂停）和恢复虚拟机</span>
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># virsh suspend centos7</span>
Domain <span class="token string">'centos7'</span> suspended
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># virsh resume centos7</span>
Domain <span class="token string">'centos7'</span> resumed
<span class="token comment"># 保存虚机状态并关闭源虚机</span>
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># virsh save centos7 centos7.9.2009</span>
Domain <span class="token string">'centos7'</span> saved to centos7.9.2009
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># virsh list --all</span>
 Id   Name      State
--------------------------
 <span class="token number">3</span>    centos    running
 -    centos7   shut off
<span class="token comment"># 恢复保存点的状态        </span>
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># virsh restore centos7.9.2009 </span>
Domain restored from centos7.9.2009
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># virsh list --all</span>
 Id   Name      State
-------------------------
 <span class="token number">3</span>    centos    running
 <span class="token number">7</span>    centos7   running
<span class="token comment"># Host上虚机的配置文件位置</span>
<span class="token punctuation">[</span>root@kvm1 qemu<span class="token punctuation">]</span><span class="token comment"># pwd</span>
/etc/libvirt/qemu
<span class="token comment"># 基于配置文件创建新的虚机</span>
<span class="token punctuation">[</span>root@kvm1 qemu<span class="token punctuation">]</span><span class="token comment"># virsh dumpxml centos7 > centos792009.xml</span>
<span class="token punctuation">[</span>root@kvm1 qemu<span class="token punctuation">]</span><span class="token comment"># ls</span>
centos792009.xml  centos7.xml  centos.xml  networks
<span class="token punctuation">[</span>root@kvm1 qemu<span class="token punctuation">]</span><span class="token comment"># virsh domblklist centos7</span>
 Target   Source
-------------------------------------------------
 vda      /var/lib/libvirt/images/centos7.qcow2
 sda      -
<span class="token comment"># 创建新的虚机文件</span>
<span class="token punctuation">[</span>root@kvm1 qemu<span class="token punctuation">]</span><span class="token comment"># cp /var/lib/libvirt/images/centos7.qcow2 /var/lib/libvirt/images/centos792009.qcow2</span>
<span class="token comment"># 删除原有UUID，并修改磁盘文件位置和配置文件名称</span>
<span class="token punctuation">[</span>root@kvm1 qemu<span class="token punctuation">]</span><span class="token comment"># vim centos792009.xml </span>
<span class="token comment"># 依据配置文件创建主机</span>
<span class="token punctuation">[</span>root@kvm1 qemu<span class="token punctuation">]</span><span class="token comment"># virsh create centos792009.xml </span>
Domain <span class="token string">'centos792009'</span> created from centos792009.xml
<span class="token comment"># 使用create命令创建的虚机只执行一次，关机即undefine.</span>
<span class="token punctuation">[</span>root@kvm1 qemu<span class="token punctuation">]</span><span class="token comment"># virsh shutdown centos792009 </span>
Domain <span class="token string">'centos792009'</span> is being <span class="token function">shutdown</span>
<span class="token punctuation">[</span>root@kvm1 qemu<span class="token punctuation">]</span><span class="token comment"># virsh list --all</span>
 Id   Name      State
-------------------------
 <span class="token number">3</span>    centos    running
 <span class="token number">7</span>    centos7   running
<span class="token comment"># 使用define命令可以创建被定义的主机，即关机仍保留可管理状态</span>
<span class="token punctuation">[</span>root@kvm1 qemu<span class="token punctuation">]</span><span class="token comment"># virsh define centos792009.xml </span>
Domain <span class="token string">'centos792009'</span> defined from centos792009.xml
<span class="token punctuation">[</span>root@kvm1 qemu<span class="token punctuation">]</span><span class="token comment"># virsh list --all</span>
 Id   Name           State
-------------------------------
 <span class="token number">3</span>    centos         running
 <span class="token number">7</span>    centos7        running
 -    centos792009   shut off
<span class="token punctuation">[</span>root@kvm1 qemu<span class="token punctuation">]</span><span class="token comment"># virsh start centos792009 </span>
Domain <span class="token string">'centos792009'</span> started
<span class="token punctuation">[</span>root@kvm1 qemu<span class="token punctuation">]</span><span class="token comment"># virsh shutdown centos792009 </span>
Domain <span class="token string">'centos792009'</span> is being <span class="token function">shutdown</span>

<span class="token punctuation">[</span>root@kvm1 qemu<span class="token punctuation">]</span><span class="token comment"># virsh list --all</span>
 Id   Name           State
-------------------------------
 <span class="token number">3</span>    centos         running
 <span class="token number">7</span>    centos7        running
 -    centos792009   shut off
<span class="token comment"># 删除虚机</span>
<span class="token punctuation">[</span>root@kvm1 qemu<span class="token punctuation">]</span><span class="token comment"># virsh undefine centos --remove-all-storage</span>
Domain <span class="token string">'centos'</span> has been undefined
Volume <span class="token string">'vda'</span><span class="token punctuation">(</span>/var/lib/libvirt/images/centos.qcow2<span class="token punctuation">)</span> removed.

<span class="token comment"># 管理快照</span>
<span class="token punctuation">[</span>root@kvm1 images<span class="token punctuation">]</span><span class="token comment"># virsh snapshot-list centos7</span>
 Name   Creation Time   State
-------------------------------
<span class="token comment"># 创建快照</span>
<span class="token punctuation">[</span>root@kvm1 images<span class="token punctuation">]</span><span class="token comment"># virsh snapshot-create centos7</span>
Domain snapshot <span class="token number">1684926926</span> created
<span class="token punctuation">[</span>root@kvm1 images<span class="token punctuation">]</span><span class="token comment"># virsh snapshot-list centos7</span>
 Name         Creation Time               State
---------------------------------------------------
 <span class="token number">1684926926</span>   <span class="token number">2023</span>-05-24 <span class="token number">19</span>:15:26 +0800   shutoff
<span class="token comment"># 应用快照</span>
<span class="token punctuation">[</span>root@kvm1 images<span class="token punctuation">]</span><span class="token comment"># virsh snapshot-revert centos7 --snapshotname 1684926926 </span>
<span class="token comment"># 删除快照</span>
<span class="token punctuation">[</span>root@kvm1 images<span class="token punctuation">]</span><span class="token comment"># virsh snapshot-delete centos7 --snapshotname 1684926926 </span>
Domain snapshot <span class="token number">1684926926</span> deleted

<span class="token punctuation">[</span>root@kvm1 images<span class="token punctuation">]</span><span class="token comment"># virsh snapshot-list centos7</span>
 Name   Creation Time   State
-------------------------------


<span class="token comment">### 管理存储</span>

<span class="token comment">#### 存储模式</span>
    - 基于文件系统的存储
    - 基于块设备的存储
<span class="token comment">#### 磁盘类型</span>
    - 固定Fixe
    - 动态Dynamic
    - 差异Differencing

<span class="token comment">#### 支持的虚拟镜像格式</span>
    - RAW
    - QCOW2
    - VMDK
    - VHD<span class="token punctuation">\</span>VHDX
    - VDI
<span class="token comment">#### QEMU-img</span>

<span class="token comment">#### 概述</span>

qemu-img是一个功能强大的磁盘镜像管理工具

```shell
<span class="token comment"># 获取帮助</span>
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># qemu-img --help</span>
check <span class="token comment">#检查完整性</span>
create <span class="token comment">#创建镜像</span>
commit <span class="token comment">#提交更改</span>
compare <span class="token comment">#比较</span>
convert <span class="token comment">#转换</span>
info <span class="token comment">#获得信息</span>
map <span class="token comment">#映射</span>
snapshot <span class="token comment">#快照管理</span>
rebase <span class="token comment">#在已有的镜像的基础上创建新的镜像</span>
resize <span class="token comment">#调整大小</span>
amend <span class="token comment">#修订镜像格式选项</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="创建磁盘文件"><a href="#创建磁盘文件" class="headerlink" title="创建磁盘文件"></a>创建磁盘文件</h4><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 基本使用格式</span>
qemu-img create <span class="token punctuation">[</span>-q<span class="token punctuation">]</span> <span class="token punctuation">[</span>--object objectdef<span class="token punctuation">]</span> <span class="token punctuation">[</span>-f fmt<span class="token punctuation">]</span> <span class="token punctuation">[</span>-b backing_file<span class="token punctuation">]</span> <span class="token punctuation">[</span>-F
backing_fmt<span class="token punctuation">]</span> <span class="token punctuation">[</span>-u<span class="token punctuation">]</span> <span class="token punctuation">[</span>-o options<span class="token punctuation">]</span> filename <span class="token punctuation">[</span>size<span class="token punctuation">]</span>
<span class="token comment"># 创建默认的稀疏格式的磁盘</span>
<span class="token punctuation">[</span>root@kvm1 images<span class="token punctuation">]</span><span class="token comment"># qemu-img create vm1.img 1g</span>
Formatting <span class="token string">'vm1.img'</span>, <span class="token assign-left variable">fmt</span><span class="token operator">=</span>raw <span class="token assign-left variable">size</span><span class="token operator">=</span><span class="token number">1073741824</span>
<span class="token punctuation">[</span>root@kvm1 images<span class="token punctuation">]</span><span class="token comment"># ll -alh</span>
total <span class="token number">6</span>.7G
drwx--x--x <span class="token number">2</span> root root  <span class="token number">108</span> May <span class="token number">24</span> <span class="token number">18</span>:10 <span class="token builtin class-name">.</span>
drwxr-xr-x <span class="token number">9</span> root root  <span class="token number">106</span> May <span class="token number">23</span> <span class="token number">18</span>:26 <span class="token punctuation">..</span>
-rw-r--r-- <span class="token number">1</span> root root <span class="token number">1</span>.0G May <span class="token number">24</span> <span class="token number">18</span>:10 vm1.img
<span class="token punctuation">[</span>root@kvm1 images<span class="token punctuation">]</span><span class="token comment"># du -h vm1.img </span>
<span class="token number">1</span>.0M	vm1.img
<span class="token punctuation">[</span>root@kvm1 images<span class="token punctuation">]</span><span class="token comment"># qemu-img info vm1.img </span>
image: vm1.img
<span class="token function">file</span> format: raw
virtual size: <span class="token number">1</span> GiB <span class="token punctuation">(</span><span class="token number">1073741824</span> bytes<span class="token punctuation">)</span>
disk size: <span class="token number">1</span> MiB<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="检查磁盘"><a href="#检查磁盘" class="headerlink" title="检查磁盘"></a>检查磁盘</h4><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 需要在虚机关机状态下进行</span>
<span class="token punctuation">[</span>root@kvm1 images<span class="token punctuation">]</span><span class="token comment"># qemu-img check ./centos792009.qcow2 </span>
No errors were found on the image.
<span class="token number">163840</span>/163840 <span class="token operator">=</span> <span class="token number">100.00</span>% allocated, <span class="token number">0.00</span>% fragmented, <span class="token number">0.00</span>% compressed clusters
Image end offset: <span class="token number">10739318784</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="磁盘预分配策略"><a href="#磁盘预分配策略" class="headerlink" title="磁盘预分配策略"></a>磁盘预分配策略</h4><p>预分配策略：</p>
<ol>
<li>off 此为默认政策，即不使用预分配，磁盘占用空间小</li>
<li>metadata 只预分配元数据，属于稀疏映像类型，相当于精简置备磁盘</li>
<li>falloc 分配文件块并标识为未初始化，即只分配空间但不置零，属于非稀疏映像，相当于厚置备延迟置零</li>
<li>full 分配所有磁盘空间并置零，属于非稀疏映像，相当于厚置备置零。<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 创建映像文件</span>
<span class="token punctuation">[</span>root@kvm1 images<span class="token punctuation">]</span><span class="token comment"># qemu-img create -f qcow2 vm2.qcow2 1g -o preallocation=off</span>
Formatting <span class="token string">'vm2.qcow2'</span>, <span class="token assign-left variable">fmt</span><span class="token operator">=</span>qcow2 <span class="token assign-left variable">cluster_size</span><span class="token operator">=</span><span class="token number">65536</span> <span class="token assign-left variable">extended_l2</span><span class="token operator">=</span>off <span class="token assign-left variable">preallocation</span><span class="token operator">=</span>off <span class="token assign-left variable">compression_type</span><span class="token operator">=</span>zlib <span class="token assign-left variable">size</span><span class="token operator">=</span><span class="token number">1073741824</span> <span class="token assign-left variable">lazy_refcounts</span><span class="token operator">=</span>off <span class="token assign-left variable">refcount_bits</span><span class="token operator">=</span><span class="token number">16</span>
<span class="token comment"># 查看文件属性</span>
<span class="token punctuation">[</span>root@kvm1 images<span class="token punctuation">]</span><span class="token comment"># qemu-img info vm2.qcow2 </span>
image: vm2.qcow2
<span class="token function">file</span> format: qcow2
virtual size: <span class="token number">1</span> GiB <span class="token punctuation">(</span><span class="token number">1073741824</span> bytes<span class="token punctuation">)</span>
disk size: <span class="token number">196</span> KiB
cluster_size: <span class="token number">65536</span>
Format specific information:
    compat: <span class="token number">1.1</span>
    compression type: zlib
    lazy refcounts: <span class="token boolean">false</span>
    refcount bits: <span class="token number">16</span>
    corrupt: <span class="token boolean">false</span>
    extended l2: <span class="token boolean">false</span>
<span class="token comment"># 只分配元数据</span>
<span class="token punctuation">[</span>root@kvm1 images<span class="token punctuation">]</span><span class="token comment"># qemu-img create -f qcow2 vm3.qcow2 1g -o preallocation=metadata</span>
Formatting <span class="token string">'vm3.qcow2'</span>, <span class="token assign-left variable">fmt</span><span class="token operator">=</span>qcow2 <span class="token assign-left variable">cluster_size</span><span class="token operator">=</span><span class="token number">65536</span> <span class="token assign-left variable">extended_l2</span><span class="token operator">=</span>off <span class="token assign-left variable">preallocation</span><span class="token operator">=</span>metadata <span class="token assign-left variable">compression_type</span><span class="token operator">=</span>zlib <span class="token assign-left variable">size</span><span class="token operator">=</span><span class="token number">1073741824</span> <span class="token assign-left variable">lazy_refcounts</span><span class="token operator">=</span>off <span class="token assign-left variable">refcount_bits</span><span class="token operator">=</span><span class="token number">16</span>
<span class="token comment"># 可见比默认文件要大</span>
<span class="token punctuation">[</span>root@kvm1 images<span class="token punctuation">]</span><span class="token comment"># qemu-img info vm3.qcow2 </span>
image: vm3.qcow2
<span class="token function">file</span> format: qcow2
virtual size: <span class="token number">1</span> GiB <span class="token punctuation">(</span><span class="token number">1073741824</span> bytes<span class="token punctuation">)</span>
disk size: <span class="token number">2</span> MiB
cluster_size: <span class="token number">65536</span>
Format specific information:
    compat: <span class="token number">1.1</span>
    compression type: zlib
    lazy refcounts: <span class="token boolean">false</span>
    refcount bits: <span class="token number">16</span>
    corrupt: <span class="token boolean">false</span>
    extended l2: <span class="token boolean">false</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
</ol>
<h4 id="磁盘格式转换"><a href="#磁盘格式转换" class="headerlink" title="磁盘格式转换"></a>磁盘格式转换</h4><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 默认转换为raw格式</span>
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># qemu-img convert CentOS8.2.vmdk CentOS8.2.img</span>
<span class="token comment"># 转化为qcow2格式</span>
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># qemu-img convert -f vmdk -O qcow2 CentOS8.2.vmdk CentOS8.2.qcow2</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="调整磁盘大小"><a href="#调整磁盘大小" class="headerlink" title="调整磁盘大小"></a>调整磁盘大小</h4><ul>
<li>操作之前，一定要做好数据备份</li>
<li>增加文件大小后，需要在客户机中使用fdisk、parted等分区工具进行相应的操作才能真正让客户机使用到增加后的镜像空间。</li>
<li>缩小镜像之前，要在客户机中保证里面的文件系统有空余空间，否则会数据丢失。另外xfs文件系统不支持缩减</li>
<li>qcow2不支持缩小镜像的操作</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 操作之前的磁盘</span>
<span class="token punctuation">[</span>root@kvm1 images<span class="token punctuation">]</span><span class="token comment"># qemu-img info vm1.img</span>
image: vm1.img
<span class="token function">file</span> format: raw
virtual size: <span class="token number">1</span> GiB <span class="token punctuation">(</span><span class="token number">1073741824</span> bytes<span class="token punctuation">)</span>
disk size: <span class="token number">1</span> MiB
<span class="token comment"># 文件扩容1GB</span>
<span class="token punctuation">[</span>root@kvm1 images<span class="token punctuation">]</span><span class="token comment"># qemu-img resize ./vm1.img +512M</span>
WARNING: Image <span class="token function">format</span> was not specified <span class="token keyword">for</span> <span class="token string">'./vm1.img'</span> and probing guessed raw.
         Automatically detecting the <span class="token function">format</span> is dangerous <span class="token keyword">for</span> raw images, <span class="token function">write</span> operations on block <span class="token number">0</span> will be restricted.
         Specify the <span class="token string">'raw'</span> <span class="token function">format</span> explicitly to remove the restrictions.
Image resized.
<span class="token comment"># 操作完成</span>
<span class="token punctuation">[</span>root@kvm1 images<span class="token punctuation">]</span><span class="token comment"># qemu-img info vm1.img</span>
image: vm1.img
<span class="token function">file</span> format: raw
virtual size: <span class="token number">1.5</span> GiB <span class="token punctuation">(</span><span class="token number">1610612736</span> bytes<span class="token punctuation">)</span>
disk size: <span class="token number">1</span> MiB
<span class="token comment"># 缩容1GB</span>
<span class="token punctuation">[</span>root@kvm1 images<span class="token punctuation">]</span><span class="token comment"># qemu-img resize --shrink ./vm1.img -1G</span>
WARNING: Image <span class="token function">format</span> was not specified <span class="token keyword">for</span> <span class="token string">'./vm1.img'</span> and probing guessed raw.
         Automatically detecting the <span class="token function">format</span> is dangerous <span class="token keyword">for</span> raw images, <span class="token function">write</span> operations on block <span class="token number">0</span> will be restricted.
         Specify the <span class="token string">'raw'</span> <span class="token function">format</span> explicitly to remove the restrictions.
Image resized.
<span class="token comment"># 缩容结果</span>
<span class="token punctuation">[</span>root@kvm1 images<span class="token punctuation">]</span><span class="token comment"># qemu-img info vm1.img</span>
image: vm1.img
<span class="token function">file</span> format: raw
virtual size: <span class="token number">512</span> MiB <span class="token punctuation">(</span><span class="token number">536870912</span> bytes<span class="token punctuation">)</span>
disk size: <span class="token number">1</span> MiB<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="快照管理"><a href="#快照管理" class="headerlink" title="快照管理"></a>快照管理</h4><p>磁盘快照的分类：</p>
<ul>
<li>按照快照信息分为：<ul>
<li>内置快照：快照数据和Base数据放在同一个qcow2文件中；</li>
<li>外置快照：快照数据单独一个qcow2文件存放；</li>
</ul>
</li>
<li>按照虚机运行状态可以分为：<ul>
<li>关机态快照：数据可以保持一致性</li>
<li>运行态快照：数据无法保证一致性，可能需要fsck操作</li>
</ul>
</li>
<li>按照磁盘数量可以分为：<ul>
<li>单盘：不涉及原子性</li>
<li>多盘：涉及原子性，要么所有盘快照都成功，要么全失败</li>
</ul>
</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 查看虚机磁盘信息</span>
<span class="token punctuation">[</span>root@kvm1 images<span class="token punctuation">]</span><span class="token comment"># virsh domblklist centos7</span>
 Target   Source
-------------------------------------------------
 vda      /var/lib/libvirt/images/centos7.qcow2
 sda      -
<span class="token comment"># 查看当前磁盘快照信息</span>
<span class="token punctuation">[</span>root@kvm1 images<span class="token punctuation">]</span><span class="token comment"># qemu-img snapshot -l centos7.qcow2 </span>
<span class="token comment"># 创建名为centos7-1的快照</span>
<span class="token punctuation">[</span>root@kvm1 images<span class="token punctuation">]</span><span class="token comment"># qemu-img snapshot -c centos7-1 ./centos7.qcow2 </span>
<span class="token comment"># 再次查看磁盘快照信息</span>
<span class="token punctuation">[</span>root@kvm1 images<span class="token punctuation">]</span><span class="token comment"># qemu-img snapshot -l centos7.qcow2 </span>
Snapshot list:
ID        TAG               VM SIZE                DATE     VM CLOCK     ICOUNT
<span class="token number">1</span>         centos7-1             <span class="token number">0</span> B <span class="token number">2023</span>-05-24 <span class="token number">19</span>:06:20 00:00:00.000          <span class="token number">0</span>
<span class="token comment"># 磁盘属性中也有快照信息</span>
<span class="token punctuation">[</span>root@kvm1 images<span class="token punctuation">]</span><span class="token comment"># qemu-img info ./centos7.qcow2 </span>
image: ./centos7.qcow2
<span class="token function">file</span> format: qcow2
virtual size: <span class="token number">10</span> GiB <span class="token punctuation">(</span><span class="token number">10737418240</span> bytes<span class="token punctuation">)</span>
disk size: <span class="token number">2.34</span> GiB
cluster_size: <span class="token number">65536</span>
Snapshot list:
ID        TAG               VM SIZE                DATE     VM CLOCK     ICOUNT
<span class="token number">1</span>         centos7-1             <span class="token number">0</span> B <span class="token number">2023</span>-05-24 <span class="token number">19</span>:06:20 00:00:00.000          <span class="token number">0</span>
Format specific information:
    compat: <span class="token number">1.1</span>
    compression type: zlib
    lazy refcounts: <span class="token boolean">true</span>
    refcount bits: <span class="token number">16</span>
    corrupt: <span class="token boolean">false</span>
    extended l2: <span class="token boolean">false</span>
<span class="token comment"># 删除文件并通过磁盘快照找回</span>
<span class="token punctuation">[</span>root@kvm1 images<span class="token punctuation">]</span><span class="token comment"># virsh start centos7</span>
Domain <span class="token string">'centos7'</span> started
<span class="token punctuation">[</span>root@kvm1 images<span class="token punctuation">]</span><span class="token comment"># virsh console centos7 </span>
Connected to domain <span class="token string">'centos7'</span>
Escape character is ^<span class="token punctuation">]</span> <span class="token punctuation">(</span>Ctrl + <span class="token punctuation">]</span><span class="token punctuation">)</span>

guest login: root
Password: 
Last login: Wed May <span class="token number">24</span> <span class="token number">11</span>:19:56 on ttyS0
<span class="token punctuation">[</span>root@guest ~<span class="token punctuation">]</span><span class="token comment"># ls</span>
anaconda-ks.cfg
<span class="token punctuation">[</span>root@guest ~<span class="token punctuation">]</span><span class="token comment"># rm anaconda-ks.cfg </span>
rm: remove regular <span class="token function">file</span> ‘anaconda-ks.cfg’? y
<span class="token punctuation">[</span>root@guest ~<span class="token punctuation">]</span><span class="token comment"># poweroff</span>

<span class="token punctuation">[</span>root@kvm1 images<span class="token punctuation">]</span><span class="token comment"># qemu-img snapshot -a centos7-1 ./centos7.qcow2 </span>
<span class="token punctuation">[</span>root@kvm1 images<span class="token punctuation">]</span><span class="token comment"># virsh start centos7</span>
Domain <span class="token string">'centos7'</span> started
<span class="token punctuation">[</span>root@kvm1 images<span class="token punctuation">]</span><span class="token comment"># virsh console centos7 </span>
Connected to domain <span class="token string">'centos7'</span>
Escape character is ^<span class="token punctuation">]</span> <span class="token punctuation">(</span>Ctrl + <span class="token punctuation">]</span><span class="token punctuation">)</span>

guest login: root
Password: 
Last login: Wed May <span class="token number">24</span> <span class="token number">11</span>:19:56 on ttyS0
<span class="token punctuation">[</span>root@guest ~<span class="token punctuation">]</span><span class="token comment"># ls</span>
anaconda-ks.cfg
<span class="token comment"># 删除磁盘快照</span>
<span class="token punctuation">[</span>root@kvm1 images<span class="token punctuation">]</span><span class="token comment"># qemu-img snapshot -d centos7-1 ./centos7.qcow2 </span>
<span class="token punctuation">[</span>root@kvm1 images<span class="token punctuation">]</span><span class="token comment"># qemu-img snapshot -l ./centos7.qcow2 </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="管理网络"><a href="#管理网络" class="headerlink" title="管理网络"></a>管理网络</h3><h4 id="查看默认网络环境"><a href="#查看默认网络环境" class="headerlink" title="查看默认网络环境"></a>查看默认网络环境</h4><p>libvirt网络的最重要组件是虚拟网络交换机，默认由Linux网桥实现，libvirt会创建virbr0，虚拟交换机的端口数量没有限制。连接网桥的接口通常被称为slave接口。</p>
<p>在libvirtd守护程序启动时，会根据配置文件创建一个default的虚拟网络，并通过配置IP转发、iptables的NAT表从而实现NAT功能。libvirt使用IP伪装（IP Masquerading)实现内部虚机访问外部。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># ipv4的转发功能已打开</span>
<span class="token punctuation">[</span>root@kvm1 images<span class="token punctuation">]</span><span class="token comment"># cat /proc/sys/net/ipv4/ip_forward</span>
<span class="token number">1</span>
<span class="token comment"># 查看当前路由表</span>
<span class="token punctuation">[</span>root@kvm1 images<span class="token punctuation">]</span><span class="token comment"># iptables -t nat -L -n</span>
Chain PREROUTING <span class="token punctuation">(</span>policy ACCEPT<span class="token punctuation">)</span>
target     prot opt <span class="token builtin class-name">source</span>               destination         

Chain INPUT <span class="token punctuation">(</span>policy ACCEPT<span class="token punctuation">)</span>
target     prot opt <span class="token builtin class-name">source</span>               destination         

Chain POSTROUTING <span class="token punctuation">(</span>policy ACCEPT<span class="token punctuation">)</span>
target     prot opt <span class="token builtin class-name">source</span>               destination         
LIBVIRT_PRT  all  --  <span class="token number">0.0</span>.0.0/0            <span class="token number">0.0</span>.0.0/0           

Chain OUTPUT <span class="token punctuation">(</span>policy ACCEPT<span class="token punctuation">)</span>
target     prot opt <span class="token builtin class-name">source</span>               destination         

Chain LIBVIRT_PRT <span class="token punctuation">(</span><span class="token number">1</span> references<span class="token punctuation">)</span>
target     prot opt <span class="token builtin class-name">source</span>               destination         
RETURN     all  --  <span class="token number">192.168</span>.122.0/24     <span class="token number">224.0</span>.0.0/24        
RETURN     all  --  <span class="token number">192.168</span>.122.0/24     <span class="token number">255.255</span>.255.255     
MASQUERADE  tcp  --  <span class="token number">192.168</span>.122.0/24    <span class="token operator">!</span><span class="token number">192.168</span>.122.0/24     masq ports: <span class="token number">1024</span>-65535
MASQUERADE  udp  --  <span class="token number">192.168</span>.122.0/24    <span class="token operator">!</span><span class="token number">192.168</span>.122.0/24     masq ports: <span class="token number">1024</span>-65535
MASQUERADE  all  --  <span class="token number">192.168</span>.122.0/24    <span class="token operator">!</span><span class="token number">192.168</span>.122.0/24  
<span class="token comment"># 由dnsmasq提供dhcp，默认地址池为192.168.122.2~254</span>
<span class="token punctuation">[</span>root@kvm1 images<span class="token punctuation">]</span><span class="token comment"># ps aux|grep dnsmq</span>
root       <span class="token number">12962</span>  <span class="token number">0.0</span>  <span class="token number">0.0</span>  <span class="token number">12144</span>  <span class="token number">1164</span> pts/0    S+   <span class="token number">19</span>:50   <span class="token number">0</span>:00 <span class="token function">grep</span> <span class="token parameter variable">--color</span><span class="token operator">=</span>auto dnsmq
<span class="token punctuation">[</span>root@kvm1 images<span class="token punctuation">]</span><span class="token comment"># cat /var/lib/libvirt/dnsmasq/default.conf </span>
<span class="token comment">##WARNING:  THIS IS AN AUTO-GENERATED FILE. CHANGES TO IT ARE LIKELY TO BE</span>
<span class="token comment">##OVERWRITTEN AND LOST.  Changes to this configuration should be made using:</span>
<span class="token comment">##    virsh net-edit default</span>
<span class="token comment">## or other application using the libvirt API.</span>
<span class="token comment">##</span>
<span class="token comment">## dnsmasq conf file created by libvirt</span>
strict-order
pid-file<span class="token operator">=</span>/run/libvirt/network/default.pid
except-interface<span class="token operator">=</span>lo
bind-dynamic
<span class="token assign-left variable">interface</span><span class="token operator">=</span>virbr0
dhcp-range<span class="token operator">=</span><span class="token number">192.168</span>.122.2,192.168.122.254,255.255.255.0
dhcp-no-override
dhcp-authoritative
dhcp-lease-max<span class="token operator">=</span><span class="token number">253</span>
dhcp-hostsfile<span class="token operator">=</span>/var/lib/libvirt/dnsmasq/default.hostsfile
addn-hosts<span class="token operator">=</span>/var/lib/libvirt/dnsmasq/default.addnhosts

<span class="token comment"># 查看虚机网络配置</span>
<span class="token comment"># 开机之前</span>
<span class="token punctuation">[</span>root@kvm1 images<span class="token punctuation">]</span><span class="token comment"># nmcli c</span>
NAME    UUID                                  TYPE      DEVICE 
ens160  b2aeba94-95b0-4944-ac7b-c20e3fc15bd0  ethernet  ens160 
virbr0  0782ace4-e598-4332-95a8-b91556cb1523  bridge    virbr0 
<span class="token punctuation">[</span>root@kvm1 images<span class="token punctuation">]</span><span class="token comment"># virsh domiflist centos7</span>
 Interface   Type      Source    Model    MAC
-------------------------------------------------------------
 -           network   default   virtio   <span class="token number">52</span>:54:00:68:0d:79
<span class="token comment"># 开机之后</span>
<span class="token punctuation">[</span>root@kvm1 images<span class="token punctuation">]</span><span class="token comment"># virsh start centos7</span>
Domain <span class="token string">'centos7'</span> started
<span class="token punctuation">[</span>root@kvm1 images<span class="token punctuation">]</span><span class="token comment"># nmcli c</span>
NAME    UUID                                  TYPE      DEVICE 
ens160  b2aeba94-95b0-4944-ac7b-c20e3fc15bd0  ethernet  ens160 
virbr0  0782ace4-e598-4332-95a8-b91556cb1523  bridge    virbr0 
vnet3   cfa6cdb4-9f5d-430f-a088-fc9e717f18b1  tun       vnet3 
<span class="token punctuation">[</span>root@kvm1 images<span class="token punctuation">]</span><span class="token comment"># virsh domiflist centos7</span>
 Interface   Type      Source    Model    MAC
-------------------------------------------------------------
 vnet2       network   default   virtio   <span class="token number">52</span>:54:00:68:0d:79
 <span class="token comment"># 新虚机设备的网络接口的名称时以vnet为开头，从0开始，并从dnsmasq获取IP地址</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="设备类型工作原理和管理"><a href="#设备类型工作原理和管理" class="headerlink" title="设备类型工作原理和管理"></a>设备类型工作原理和管理</h4><p>虚拟网络接口设备功能与物理网卡类似，有两种常用类型：TAP、TUN。TUN、TAP是没有关联物理设备的虚拟接口，用户空间程序可以附加到TUN&#x2F;TAP接口并处理发送到该接口的流量。可以为该接口分配IP地址、路由数据包到该接口、分析流量等。应用场景为VPN和云计算。</p>
<p>TUN设备在OSI3层运行，实现虚拟IP点对点接口，没有Mac地址，不能称为网桥的slave设备。</p>
<p>TAP设备运行在OSI模型的2层，可以接受和发送原始以太网数据包，有Mac地址，可以成为网桥的slave设备。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 创建tap设备</span>
<span class="token punctuation">[</span>root@kvm1 images<span class="token punctuation">]</span><span class="token comment"># ip tuntap add dev tap-nic1 mode tap</span>
<span class="token punctuation">[</span>root@kvm1 images<span class="token punctuation">]</span><span class="token comment"># ip link</span>
<span class="token number">1</span>: lo: <span class="token operator">&lt;</span>LOOPBACK,UP,LOWER_UP<span class="token operator">></span> mtu <span class="token number">65536</span> qdisc noqueue state UNKNOWN mode DEFAULT group default qlen <span class="token number">1000</span>
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
<span class="token number">2</span>: ens160: <span class="token operator">&lt;</span>BROADCAST,MULTICAST,UP,LOWER_UP<span class="token operator">></span> mtu <span class="token number">1500</span> qdisc mq state UP mode DEFAULT group default qlen <span class="token number">1000</span>
    link/ether 00:0c:29:a9:29:c5 brd ff:ff:ff:ff:ff:ff
    altname enp3s0
<span class="token number">3</span>: virbr0: <span class="token operator">&lt;</span>BROADCAST,MULTICAST,UP,LOWER_UP<span class="token operator">></span> mtu <span class="token number">1500</span> qdisc noqueue state UP mode DEFAULT group default qlen <span class="token number">1000</span>
    link/ether <span class="token number">52</span>:54:00:16:e8:45 brd ff:ff:ff:ff:ff:ff
<span class="token number">7</span>: vnet3: <span class="token operator">&lt;</span>BROADCAST,MULTICAST,UP,LOWER_UP<span class="token operator">></span> mtu <span class="token number">1500</span> qdisc noqueue master virbr0 state UNKNOWN mode DEFAULT group default qlen <span class="token number">1000</span>
    link/ether fe:54:00:68:0d:79 brd ff:ff:ff:ff:ff:ff
<span class="token number">8</span>: tap-nic1: <span class="token operator">&lt;</span>BROADCAST,MULTICAST<span class="token operator">></span> mtu <span class="token number">1500</span> qdisc noop state DOWN mode DEFAULT group default qlen <span class="token number">1000</span>
    link/ether ce:b1:d6:f5:b2:be brd ff:ff:ff:ff:ff:ff
<span class="token comment"># 删除tap设备</span>
<span class="token punctuation">[</span>root@kvm1 images<span class="token punctuation">]</span><span class="token comment"># ip tuntap del dev tap-nic1 mode tap</span>
<span class="token comment"># 使用NetworkManager来新增一个tun设备</span>
<span class="token punctuation">[</span>root@kvm1 images<span class="token punctuation">]</span><span class="token comment"># nmcli c add type tun con-name newcon1 ifname tap-nic2 mode tap ip4 172.16.123.2/24</span>
Connection <span class="token string">'newcon1'</span> <span class="token punctuation">(</span>7b45dbc7-ffe2-4375-9377-9cb94238ac42<span class="token punctuation">)</span> successfully added.
<span class="token punctuation">[</span>root@kvm1 images<span class="token punctuation">]</span><span class="token comment"># nmcli c</span>
NAME     UUID                                  TYPE      DEVICE   
ens160   b2aeba94-95b0-4944-ac7b-c20e3fc15bd0  ethernet  ens160   
newcon1  7b45dbc7-ffe2-4375-9377-9cb94238ac42  tun       tap-nic2 
virbr0   0782ace4-e598-4332-95a8-b91556cb1523  bridge    virbr0   
vnet3    cfa6cdb4-9f5d-430f-a088-fc9e717f18b1  tun       vnet3    
<span class="token punctuation">[</span>root@kvm1 images<span class="token punctuation">]</span><span class="token comment"># ip tuntap list</span>
vnet3: tap vnet_hdr
tap-nic2: tap persist<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="KVM-x2F-libvirt常用网络类型"><a href="#KVM-x2F-libvirt常用网络类型" class="headerlink" title="KVM&#x2F;libvirt常用网络类型"></a>KVM&#x2F;libvirt常用网络类型</h4><ul>
<li>NAT模式</li>
<li>桥接模式</li>
<li>隔离模式</li>
<li>路由模式</li>
<li>开封模式</li>
<li>直接附加模式</li>
<li>PCI直通与SR-IOV</li>
</ul>
<h3 id="管理存储"><a href="#管理存储" class="headerlink" title="管理存储"></a>管理存储</h3><p>虚拟存储时可以分配给虚机的存储空军，是宿主机物理存储的一部分，是通过模拟或者半虚拟化的快设备驱动程序分配给虚机的存储。由Libvirt创建和管理的存储称为托管存储(Managed Storage)，管理员手工创建的则被称为非托管存储。</p>
<h4 id="术语"><a href="#术语" class="headerlink" title="术语"></a>术语</h4><ul>
<li>虚拟机设备</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># type 设备类型</span>
<span class="token function">file</span> block <span class="token function">dir</span> network volume nvme，默认为file
<span class="token comment"># device 设备</span>
floppy cdrom disk lun，默认为disk
<span class="token comment"># source 源地址</span>
<span class="token comment"># bus 指定要模拟的设备类型，或者指驱动程序</span>
ide scsi virtio usb sata sd<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>宿主机设备</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 映像文件</span>
<span class="token comment"># LVM卷</span>
<span class="token comment"># 宿主设备</span>
<span class="token comment"># 分布式存储系统</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="存储池"><a href="#存储池" class="headerlink" title="存储池"></a>存储池</h4><h5 id="概念-1"><a href="#概念-1" class="headerlink" title="概念"></a>概念</h5><p>存储池是由Libvirt管理的为虚机预留的宿主机上的存储容量，可以在存储池的空间中创建存储卷，然后将存储卷当作块设备分配给虚机。存储池屏蔽了底层物理路径，提高的系统管理的灵活性。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 查看宿主机存储池情况</span>
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># virsh pool-list --all --details</span>
 Name      State     Autostart   Persistent   Capacity    Allocation   Available
----------------------------------------------------------------------------------
 default   running   <span class="token function">yes</span>         <span class="token function">yes</span>          <span class="token number">16.40</span> GiB   <span class="token number">7.01</span> GiB     <span class="token number">9.39</span> GiB
 ISO       running   <span class="token function">yes</span>         <span class="token function">yes</span>          <span class="token number">9.99</span> GiB    <span class="token number">1.05</span> GiB     <span class="token number">8.93</span> GiB
 KVM       running   <span class="token function">yes</span>         <span class="token function">yes</span>          <span class="token number">9.99</span> GiB    <span class="token number">1.05</span> GiB     <span class="token number">8.93</span> GiB
 NFS       running   <span class="token function">yes</span>         <span class="token function">yes</span>          <span class="token number">49.97</span> GiB   <span class="token number">3.25</span> GiB     <span class="token number">46.72</span> GiB
<span class="token comment"># 查看指定存储池详细信息</span>
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># virsh pool-info NFS</span>
Name:           NFS
UUID:           a761ebee-3a45-484b-9464-e80e79b078b3
State:          running
Persistent:     <span class="token function">yes</span>
Autostart:      <span class="token function">yes</span>
Capacity:       <span class="token number">49.97</span> GiB
Allocation:     <span class="token number">3.25</span> GiB
Available:      <span class="token number">46.72</span> GiB
<span class="token comment"># 查看执行存储池XML配置</span>
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># virsh pool-dumpxml ISO</span>
<span class="token operator">&lt;</span>pool <span class="token assign-left variable">type</span><span class="token operator">=</span><span class="token string">'dir'</span><span class="token operator">></span>
  <span class="token operator">&lt;</span>name<span class="token operator">></span>ISO<span class="token operator">&lt;</span>/name<span class="token operator">></span>
  <span class="token operator">&lt;</span>uuid<span class="token operator">></span>7c0205b7-a6f7-4381-a509-bb5bd2d5a77<span class="token operator"><span class="token file-descriptor important">0</span>&lt;</span>/uuid<span class="token operator">></span>
  <span class="token operator">&lt;</span>capacity <span class="token assign-left variable">unit</span><span class="token operator">=</span><span class="token string">'bytes'</span><span class="token operator">></span><span class="token number">1072273817</span><span class="token operator"><span class="token file-descriptor important">6</span>&lt;</span>/capacity<span class="token operator">></span>
  <span class="token operator">&lt;</span>allocation <span class="token assign-left variable">unit</span><span class="token operator">=</span><span class="token string">'bytes'</span><span class="token operator">></span><span class="token number">112893542</span><span class="token operator"><span class="token file-descriptor important">4</span>&lt;</span>/allocation<span class="token operator">></span>
  <span class="token operator">&lt;</span>available <span class="token assign-left variable">unit</span><span class="token operator">=</span><span class="token string">'bytes'</span><span class="token operator">></span><span class="token number">959380275</span><span class="token operator"><span class="token file-descriptor important">2</span>&lt;</span>/available<span class="token operator">></span>
  <span class="token operator">&lt;</span>source<span class="token operator">></span>
  <span class="token operator">&lt;</span>/source<span class="token operator">></span>
  <span class="token operator">&lt;</span>target<span class="token operator">></span>
    <span class="token operator">&lt;</span>path<span class="token operator">></span>/data/iso<span class="token operator">&lt;</span>/path<span class="token operator">></span>
    <span class="token operator">&lt;</span>permissions<span class="token operator">></span>
      <span class="token operator">&lt;</span>mode<span class="token operator">></span>075<span class="token operator"><span class="token file-descriptor important">5</span>&lt;</span>/mode<span class="token operator">></span>
      <span class="token operator">&lt;</span>owner<span class="token operator">></span><span class="token operator"><span class="token file-descriptor important">0</span>&lt;</span>/owner<span class="token operator">></span>
      <span class="token operator">&lt;</span>group<span class="token operator">></span><span class="token operator"><span class="token file-descriptor important">0</span>&lt;</span>/group<span class="token operator">></span>
    <span class="token operator">&lt;</span>/permissions<span class="token operator">></span>
  <span class="token operator">&lt;</span>/target<span class="token operator">></span>
<span class="token operator">&lt;</span>/pool<span class="token operator">></span>
<span class="token comment"># 存储池配置文件</span>
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># tree /etc/libvirt/storage/</span>
/etc/libvirt/storage/
├── autostart
│   ├── default.xml -<span class="token operator">></span> /etc/libvirt/storage/default.xml
│   ├── ISO.xml -<span class="token operator">></span> /etc/libvirt/storage/ISO.xml
│   ├── KVM.xml -<span class="token operator">></span> /etc/libvirt/storage/KVM.xml
│   └── NFS.xml -<span class="token operator">></span> /etc/libvirt/storage/NFS.xml
├── default.xml
├── ISO.xml
├── KVM.xml
└── NFS.xml

<span class="token number">1</span> directory, <span class="token number">8</span> files<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h5 id="创建"><a href="#创建" class="headerlink" title="创建"></a>创建</h5><p>存储池按照时效性划分可以有持久型存储池和临时性存储池；按底层存储技术可以分为基于目录、基于磁盘、基于分区、基于GlusterFS、基于iSCSI、基于LVM、基于ZFS等多种存储池；按照存储位置可以分为本地存储池和共享存储池。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># virsh pool-create-as --</span>
--adapter-name               --adapter-parent-wwpn        --auth-username              <span class="token parameter variable">--overwrite</span>                  --source-dev                 --source-name                <span class="token parameter variable">--type</span>
--adapter-parent             --adapter-wwnn               <span class="token parameter variable">--build</span>                      --print-xml                  --source-format              --source-path                
--adapter-parent-fabric-wwn  --adapter-wwpn               <span class="token parameter variable">--name</span>                       --secret-usage               --source-host                --source-protocol-ver        
--adapter-parent-wwnn        --auth-type                  --no-overwrite               --secret-uuid                --source-initiator           <span class="token parameter variable">--target</span>                     
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># virsh pool-create-as --type </span>
<span class="token function">dir</span>           disk          fs            gluster       iscsi         iscsi-direct  logical       mpath         netfs         rbd           scsi          sheepdog      vstorage      zfs<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>存储池创建的流程：</p>
<ol>
<li>定义(define)存储池</li>
<li>构建(build)存储池目标路径</li>
<li>启动(start)存储池</li>
<li>将存储池设置为自动启动(autostrat)</li>
</ol>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 创建基于目录的存储池</span>
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># virsh pool-define-as --name test --type dir --target "/data/test"</span>
Pool <span class="token builtin class-name">test</span> defined
<span class="token comment"># 查看配置文件信息</span>
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># cat /etc/libvirt/storage/test.xml </span>
<span class="token operator">&lt;</span><span class="token operator">!</span>--
WARNING: THIS IS AN AUTO-GENERATED FILE. CHANGES TO IT ARE LIKELY TO BE
OVERWRITTEN AND LOST. Changes to this xml configuration should be made using:
  <span class="token function">virsh</span> pool-edit <span class="token builtin class-name">test</span>
or other application using the libvirt API.
--<span class="token operator">></span>

<span class="token operator">&lt;</span>pool <span class="token assign-left variable">type</span><span class="token operator">=</span><span class="token string">'dir'</span><span class="token operator">></span>
  <span class="token operator">&lt;</span>name<span class="token operator">></span>test<span class="token operator">&lt;</span>/name<span class="token operator">></span>
  <span class="token operator">&lt;</span>uuid<span class="token operator">></span>056536d5-b816-4b49-b822-a3b65a6c917a<span class="token operator">&lt;</span>/uuid<span class="token operator">></span>
  <span class="token operator">&lt;</span>capacity <span class="token assign-left variable">unit</span><span class="token operator">=</span><span class="token string">'bytes'</span><span class="token operator">></span><span class="token operator"><span class="token file-descriptor important">0</span>&lt;</span>/capacity<span class="token operator">></span>
  <span class="token operator">&lt;</span>allocation <span class="token assign-left variable">unit</span><span class="token operator">=</span><span class="token string">'bytes'</span><span class="token operator">></span><span class="token operator"><span class="token file-descriptor important">0</span>&lt;</span>/allocation<span class="token operator">></span>
  <span class="token operator">&lt;</span>available <span class="token assign-left variable">unit</span><span class="token operator">=</span><span class="token string">'bytes'</span><span class="token operator">></span><span class="token operator"><span class="token file-descriptor important">0</span>&lt;</span>/available<span class="token operator">></span>
  <span class="token operator">&lt;</span>source<span class="token operator">></span>
  <span class="token operator">&lt;</span>/source<span class="token operator">></span>
  <span class="token operator">&lt;</span>target<span class="token operator">></span>
    <span class="token operator">&lt;</span>path<span class="token operator">></span>/data/test<span class="token operator">&lt;</span>/path<span class="token operator">></span>
  <span class="token operator">&lt;</span>/target<span class="token operator">></span>
<span class="token operator">&lt;</span>/pool<span class="token operator">></span>
<span class="token comment"># 当前并不会创建池</span>
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># virsh pool-list</span>
 Name      State    Autostart
-------------------------------
 default   active   <span class="token function">yes</span>
 ISO       active   <span class="token function">yes</span>
 KVM       active   <span class="token function">yes</span>
 NFS       active   <span class="token function">yes</span>
<span class="token comment"># 构建存储池</span>
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># virsh pool-build test</span>
Pool <span class="token builtin class-name">test</span> built
<span class="token comment"># 依然没有存储池，build命令会自动创建文件目录</span>
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># virsh pool-list</span>
 Name      State    Autostart
-------------------------------
 default   active   <span class="token function">yes</span>
 ISO       active   <span class="token function">yes</span>
 KVM       active   <span class="token function">yes</span>
 NFS       active   <span class="token function">yes</span>
<span class="token comment"># 启动存储池</span>
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># virsh pool-start test</span>
Pool <span class="token builtin class-name">test</span> started
<span class="token comment"># 可见存储池已经可用，但是临时性的</span>
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># virsh pool-list</span>
 Name      State    Autostart
-------------------------------
 default   active   <span class="token function">yes</span>
 ISO       active   <span class="token function">yes</span>
 KVM       active   <span class="token function">yes</span>
 NFS       active   <span class="token function">yes</span>
 <span class="token builtin class-name">test</span>      active   no
<span class="token comment"># 配置自动启动</span>
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># virsh pool-autostart test </span>
Pool <span class="token builtin class-name">test</span> marked as autostarted

<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># virsh pool-list</span>
 Name      State    Autostart
-------------------------------
 default   active   <span class="token function">yes</span>
 ISO       active   <span class="token function">yes</span>
 KVM       active   <span class="token function">yes</span>
 NFS       active   <span class="token function">yes</span>
 <span class="token builtin class-name">test</span>      active   <span class="token function">yes</span>
<span class="token comment"># 删除存储池test</span>
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># virsh pool-destroy test </span>
<span class="token comment"># 列表中删除test存储池</span>
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># virsh pool-list</span>
 Name      State    Autostart
-------------------------------
 default   active   <span class="token function">yes</span>
 ISO       active   <span class="token function">yes</span>
 KVM       active   <span class="token function">yes</span>
 NFS       active   <span class="token function">yes</span>
<span class="token comment"># test配置文件保留  </span>
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># cat /etc/libvirt/storage/test.xml </span>
<span class="token operator">&lt;</span><span class="token operator">!</span>--
WARNING: THIS IS AN AUTO-GENERATED FILE. CHANGES TO IT ARE LIKELY TO BE
OVERWRITTEN AND LOST. Changes to this xml configuration should be made using:
  <span class="token function">virsh</span> pool-edit <span class="token builtin class-name">test</span>
or other application using the libvirt API.
--<span class="token operator">></span>

<span class="token operator">&lt;</span>pool <span class="token assign-left variable">type</span><span class="token operator">=</span><span class="token string">'dir'</span><span class="token operator">></span>
  <span class="token operator">&lt;</span>name<span class="token operator">></span>test<span class="token operator">&lt;</span>/name<span class="token operator">></span>
  <span class="token operator">&lt;</span>uuid<span class="token operator">></span>056536d5-b816-4b49-b822-a3b65a6c917a<span class="token operator">&lt;</span>/uuid<span class="token operator">></span>
  <span class="token operator">&lt;</span>capacity <span class="token assign-left variable">unit</span><span class="token operator">=</span><span class="token string">'bytes'</span><span class="token operator">></span><span class="token operator"><span class="token file-descriptor important">0</span>&lt;</span>/capacity<span class="token operator">></span>
  <span class="token operator">&lt;</span>allocation <span class="token assign-left variable">unit</span><span class="token operator">=</span><span class="token string">'bytes'</span><span class="token operator">></span><span class="token operator"><span class="token file-descriptor important">0</span>&lt;</span>/allocation<span class="token operator">></span>
  <span class="token operator">&lt;</span>available <span class="token assign-left variable">unit</span><span class="token operator">=</span><span class="token string">'bytes'</span><span class="token operator">></span><span class="token operator"><span class="token file-descriptor important">0</span>&lt;</span>/available<span class="token operator">></span>
  <span class="token operator">&lt;</span>source<span class="token operator">></span>
  <span class="token operator">&lt;</span>/source<span class="token operator">></span>
  <span class="token operator">&lt;</span>target<span class="token operator">></span>
    <span class="token operator">&lt;</span>path<span class="token operator">></span>/data/test<span class="token operator">&lt;</span>/path<span class="token operator">></span>
  <span class="token operator">&lt;</span>/target<span class="token operator">></span>
<span class="token operator">&lt;</span>/pool<span class="token operator">></span>
<span class="token comment"># 删除配置</span>
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># virsh pool-undefine test </span>
Pool <span class="token builtin class-name">test</span> has been undefined
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># cat /etc/libvirt/storage/</span>
autostart/   default.xml  ISO.xml      KVM.xml      NFS.xml 
<span class="token comment"># 创建NFS共享为存储池</span>
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># virsh pool-create-as NFS netfs --source-host=stor1 --source-path=/data/nfs --target=/data/nfs</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="存储卷"><a href="#存储卷" class="headerlink" title="存储卷"></a>存储卷</h3><p>可以将存储池划分为存储卷，它可以使映像文件、物理分区、LVM卷或者其他可以被libvirt管理的存储。无论底层硬件架构如何，存储卷都将以块设备附加到虚机。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 查看存储池的卷</span>
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># virsh vol-list NFS</span>
 Name                Path
--------------------------------------------------
 centosshare.qcow2   /data/nfs/centosshare.qcow2
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># virsh vol-list ISO --details</span>
 Name                               Path                                         Type   Capacity     Allocation
-----------------------------------------------------------------------------------------------------------------
 CentOS-7-x86_64-Minimal-2009.iso   /data/iso/CentOS-7-x86_64-Minimal-2009.iso   <span class="token function">file</span>   <span class="token number">973.00</span> MiB   <span class="token number">973.00</span> MiB
 <span class="token comment"># 相关参数</span>
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># virsh vol-</span>
vol-clone        vol-create-as    vol-delete       vol-dumpxml      vol-key          vol-name         vol-pool         vol-upload       
vol-create       vol-create-from  vol-download     vol-info         vol-list         vol-path         vol-resize       vol-wipe   
<span class="token comment"># 创建一个10GB大小的预先分配元数据的存储卷</span>
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># virsh vol-create-as --pool NFS --name rocky.qcow2 --format qcow2 --capacity 10G --prealloc-metadata </span>
Vol rocky.qcow2 created
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># virsh vol-list --pool NFS --details </span>
 Name                Path                          Type   Capacity    Allocation
----------------------------------------------------------------------------------
 centosshare.qcow2   /data/nfs/centosshare.qcow2   <span class="token function">file</span>   <span class="token number">10.00</span> GiB   <span class="token number">2.87</span> GiB
 rocky.qcow2         /data/nfs/rocky.qcow2         <span class="token function">file</span>   <span class="token number">10.00</span> GiB   <span class="token number">12.00</span> GiB
<span class="token comment"># 创建一个默认不提前分配磁盘的存储卷</span>
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># virsh vol-create-as --pool NFS --name rocky9.qcow2 --format qcow2 --capacity 10G </span>
Vol rocky9.qcow2 created

<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># qemu-img info /data/nfs/rocky9.qcow2 </span>
image: /data/nfs/rocky9.qcow2
<span class="token function">file</span> format: qcow2
virtual size: <span class="token number">10</span> GiB <span class="token punctuation">(</span><span class="token number">10737418240</span> bytes<span class="token punctuation">)</span>
disk size: <span class="token number">196</span> KiB
cluster_size: <span class="token number">65536</span>
Format specific information:
    compat: <span class="token number">0.10</span>
    compression type: zlib
    refcount bits: <span class="token number">16</span>
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># virsh vol-list --pool NFS --details </span>
 Name                Path                          Type   Capacity    Allocation
----------------------------------------------------------------------------------
 centosshare.qcow2   /data/nfs/centosshare.qcow2   <span class="token function">file</span>   <span class="token number">10.00</span> GiB   <span class="token number">2.87</span> GiB
 rocky.qcow2         /data/nfs/rocky.qcow2         <span class="token function">file</span>   <span class="token number">10.00</span> GiB   <span class="token number">12.00</span> GiB
 rocky9.qcow2        /data/nfs/rocky9.qcow2        <span class="token function">file</span>   <span class="token number">10.00</span> GiB   <span class="token number">196.00</span> KiB
<span class="token comment"># 附加磁盘到centos7虚机，使用--config表示重启或者再启动后添加，默认需要虚机处于开机状态才能添加</span>
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># virsh attach-disk --domain centos7 --cache none --source /data/nfs/rocky.qcow2 --target vdb --config </span>
Disk attached successfully
<span class="token comment"># 分离存储卷</span>
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># virsh detach-disk --domain centos7 --target vdb --config </span>
Disk detached successfully
<span class="token comment"># 擦除存储卷</span>
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># virsh vol-wipe --pool NFS --vol rocky.qcow2 </span>
Vol rocky.qcow2 wiped
<span class="token comment"># 删除存储卷</span>
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># virsh vol-delete --pool NFS --vol rocky.qcow2</span>
Vol rocky.qcow2 deleted<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>





<h2 id="进阶"><a href="#进阶" class="headerlink" title="进阶"></a>进阶</h2><h3 id="虚机的迁移"><a href="#虚机的迁移" class="headerlink" title="虚机的迁移"></a>虚机的迁移</h3><p>KVM虚机由XML配置我呢见和磁盘映像组成，如果虚机正在运行则还要考虑内存的迁移。按照目标宿主机的位置来分，虚机迁移分为两种：内部迁移和宿主机之间的迁移。按照虚机的状态来区分，虚机迁移分为3种：实时(虚机处于运行状态)迁移、非实时(虚机处于休眠状态)迁移和离线(虚机处于关机状态)迁移。</p>
<p>虚机迁移的要求：</p>
<ol>
<li>尽量使用共享存储，非共享存储需要添加 –copy-storage来实现迁移；</li>
<li>对宿主机操作系统版本号有要求RHEL7.5之后可以迁移到RHEL8，反之则不可以。RHEL8各个版本可以互相迁移；</li>
</ol>
<p>虚机迁移的限制：</p>
<ol>
<li>使用直通设备的，不支持迁移</li>
<li>使用单根虚拟化设备(SR-IOV)的，不支持迁移</li>
<li>使用vGPU设备的，不支持迁移</li>
<li>需要支持NUMA</li>
</ol>
<h4 id="宿主机内部迁移"><a href="#宿主机内部迁移" class="headerlink" title="宿主机内部迁移"></a>宿主机内部迁移</h4><p>KVM的宿主机内部迁移无法通过cockpit或者virsh命令完成，需要手动执行：</p>
<ol>
<li>使用mv迁移磁盘文件、XML配置文件</li>
<li>修改XML配置文件</li>
<li>无需重新define虚机</li>
</ol>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># Host主机有三个存储池，现将default池内的centos模板虚机迁移到KVM池</span>
<span class="token punctuation">[</span>root@kvm1 data<span class="token punctuation">]</span><span class="token comment"># virsh pool-list</span>
 Name      State    Autostart
-------------------------------
 default   active   <span class="token function">yes</span>
 ISO       active   <span class="token function">yes</span>
 KVM       active   <span class="token function">yes</span>
<span class="token punctuation">[</span>root@kvm1 data<span class="token punctuation">]</span><span class="token comment"># virsh list --all</span>
 Id   Name           State
-------------------------------
 <span class="token number">1</span>    centos7        running
 -    centos         shut off
<span class="token comment"># 迁移磁盘文件到存储池KVM</span>
<span class="token punctuation">[</span>root@kvm1 data<span class="token punctuation">]</span><span class="token comment"># mv /var/lib/libvirt/images/centos.qcow2 /data/kvm/centos.qcow2</span>
<span class="token comment"># 修改配置文件</span>
<span class="token punctuation">[</span>root@kvm1 data<span class="token punctuation">]</span><span class="token comment"># vim /etc/libvirt/qemu/centos.xml</span>
<span class="token comment"># 方法一，使用file参数直接写入磁盘文件的硬路径：</span>
    <span class="token operator">&lt;</span>disk <span class="token assign-left variable">type</span><span class="token operator">=</span><span class="token string">'file'</span> <span class="token assign-left variable">device</span><span class="token operator">=</span><span class="token string">'disk'</span><span class="token operator">></span>
      <span class="token operator">&lt;</span>driver <span class="token assign-left variable">name</span><span class="token operator">=</span><span class="token string">'qemu'</span> <span class="token assign-left variable">type</span><span class="token operator">=</span><span class="token string">'qcow2'</span>/<span class="token operator">></span>
      <span class="token operator">&lt;</span>source <span class="token assign-left variable">file</span><span class="token operator">=</span><span class="token string">'/data/kvm/centos.qcow2'</span>/<span class="token operator">></span>
      <span class="token operator">&lt;</span>backingStore/<span class="token operator">></span>
      <span class="token operator">&lt;</span>target <span class="token assign-left variable">dev</span><span class="token operator">=</span><span class="token string">'vda'</span> <span class="token assign-left variable">bus</span><span class="token operator">=</span><span class="token string">'virtio'</span>/<span class="token operator">></span>
      <span class="token operator">&lt;</span>address <span class="token assign-left variable">type</span><span class="token operator">=</span><span class="token string">'pci'</span> <span class="token assign-left variable">domain</span><span class="token operator">=</span><span class="token string">'0x0000'</span> <span class="token assign-left variable">bus</span><span class="token operator">=</span><span class="token string">'0x04'</span> <span class="token assign-left variable">slot</span><span class="token operator">=</span><span class="token string">'0x00'</span> <span class="token assign-left variable">function</span><span class="token operator">=</span><span class="token string">'0x0'</span>/<span class="token operator">></span>
    <span class="token operator">&lt;</span>/disk<span class="token operator">></span>
<span class="token comment"># 方法二,使用volume参数指定pool中的磁盘：</span>
    <span class="token operator">&lt;</span>disk <span class="token assign-left variable">type</span><span class="token operator">=</span><span class="token string">'volume'</span> <span class="token assign-left variable">device</span><span class="token operator">=</span><span class="token string">'disk'</span><span class="token operator">></span>
      <span class="token operator">&lt;</span>driver <span class="token assign-left variable">name</span><span class="token operator">=</span><span class="token string">'qemu'</span> <span class="token assign-left variable">type</span><span class="token operator">=</span><span class="token string">'qcow2'</span>/<span class="token operator">></span>
      <span class="token operator">&lt;</span>source <span class="token assign-left variable">pool</span><span class="token operator">=</span><span class="token string">'kvm'</span> <span class="token assign-left variable">volume</span><span class="token operator">=</span><span class="token string">'/data/kvm/centos.qcow2'</span>/<span class="token operator">></span>
      <span class="token operator">&lt;</span>backingStore/<span class="token operator">></span>
      <span class="token operator">&lt;</span>target <span class="token assign-left variable">dev</span><span class="token operator">=</span><span class="token string">'vda'</span> <span class="token assign-left variable">bus</span><span class="token operator">=</span><span class="token string">'virtio'</span>/<span class="token operator">></span>
      <span class="token operator">&lt;</span>address <span class="token assign-left variable">type</span><span class="token operator">=</span><span class="token string">'pci'</span> <span class="token assign-left variable">domain</span><span class="token operator">=</span><span class="token string">'0x0000'</span> <span class="token assign-left variable">bus</span><span class="token operator">=</span><span class="token string">'0x04'</span> <span class="token assign-left variable">slot</span><span class="token operator">=</span><span class="token string">'0x00'</span> <span class="token assign-left variable">function</span><span class="token operator">=</span><span class="token string">'0x0'</span>/<span class="token operator">></span>
    <span class="token operator">&lt;</span>/disk<span class="token operator">></span>
<span class="token comment"># 开机检查</span>
<span class="token punctuation">[</span>root@kvm1 data<span class="token punctuation">]</span><span class="token comment"># virsh start centos</span>
Domain <span class="token string">'centos'</span> started
<span class="token punctuation">[</span>root@kvm1 data<span class="token punctuation">]</span><span class="token comment"># virsh list</span>
 Id   Name      State
-------------------------
 <span class="token number">1</span>    centos7   running
 <span class="token number">3</span>    centos    running<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="基于共享存储迁移"><a href="#基于共享存储迁移" class="headerlink" title="基于共享存储迁移"></a>基于共享存储迁移</h4><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 添加防护的例外</span>
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># firewall-cmd --add-service=&#123;libvirt,libvirt-tls&#125; --permanent</span>
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># firewall-cmd --add-port=49152-49215/tcp --permanent</span>
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># firewall-cmd --reload</span>
<span class="token comment"># 添加域名解析</span>
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># cat /etc/hosts </span>
<span class="token number">127.0</span>.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
::1         localhost localhost.localdomain localhost6 localhost6.localdomain6
<span class="token number">192.168</span>.10.140	kvm1
<span class="token number">192.168</span>.10.141	kvm2
<span class="token number">192.168</span>.10.142	stor1
<span class="token comment"># 配置共享存储</span>
<span class="token comment"># 在所有主机上运行 yum install -y nfs-utils</span>
<span class="token comment"># 在存储主机上配置NFS</span>
<span class="token punctuation">[</span>root@stor1 ~<span class="token punctuation">]</span><span class="token comment"># vim /etc/exports</span>
/data/nfs       <span class="token number">192.168</span>.10.0/24<span class="token punctuation">(</span>rw,no_root_squash<span class="token punctuation">)</span>
<span class="token punctuation">[</span>root@stor1 ~<span class="token punctuation">]</span><span class="token comment"># systemctl enable --now nfs-server</span>
Created symlink /etc/systemd/system/multi-user.target.wants/nfs-server.service → /usr/lib/systemd/system/nfs-server.service.
<span class="token punctuation">[</span>root@stor1 ~<span class="token punctuation">]</span><span class="token comment"># systemctl enable --now rpcbind</span>
<span class="token punctuation">[</span>root@stor1 ~<span class="token punctuation">]</span><span class="token comment"># firewall-cmd --permanent --add-service=nfs</span>
success
<span class="token punctuation">[</span>root@stor1 ~<span class="token punctuation">]</span><span class="token comment"># firewall-cmd --reload</span>
success
<span class="token comment"># 在宿主机1号上挂载nfs</span>
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># mkdir /data/nfs</span>
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># virsh pool-create-as NFS netfs --source-host=stor1 --source-path=/data/nfs --target=/data/nfs</span>
<span class="token comment"># 在宿主机2号上挂载nfs</span>
<span class="token punctuation">[</span>root@kvm2 ~<span class="token punctuation">]</span><span class="token comment"># mkdir /data/nfs</span>
<span class="token punctuation">[</span>root@kvm2 ~<span class="token punctuation">]</span><span class="token comment"># virsh pool-create-as NFS netfs --source-host=stor1 --source-path=/data/nfs --target=/data/nfs</span>
<span class="token comment"># 在宿主机上将default磁盘池中的centos虚机磁盘迁移至共享存储上</span>
<span class="token comment"># 迁移磁盘文件到存储池KVM</span>
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># mv /var/lib/libvirt/images/centos.qcow2 /data/nfs/centos-share.qcow2</span>
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># virsh dumpxml centos > /etc/libvirt/qemu/centos-share.xml</span>
<span class="token comment"># 修改配置文件</span>
<span class="token comment"># 删除UUID并修改主机名为centos-share</span>
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># vim /etc/libvirt/qemu/centos-share.xml</span>
    <span class="token operator">&lt;</span>disk <span class="token assign-left variable">type</span><span class="token operator">=</span><span class="token string">'volume'</span> <span class="token assign-left variable">device</span><span class="token operator">=</span><span class="token string">'disk'</span><span class="token operator">></span>
      <span class="token operator">&lt;</span>driver <span class="token assign-left variable">name</span><span class="token operator">=</span><span class="token string">'qemu'</span> <span class="token assign-left variable">type</span><span class="token operator">=</span><span class="token string">'qcow2'</span>/<span class="token operator">></span>
      <span class="token operator">&lt;</span>source <span class="token assign-left variable">pool</span><span class="token operator">=</span><span class="token string">'kvm'</span> <span class="token assign-left variable">volume</span><span class="token operator">=</span><span class="token string">'/data/nfs/centos-share.qcow2'</span>/<span class="token operator">></span>
      <span class="token operator">&lt;</span>backingStore/<span class="token operator">></span>
      <span class="token operator">&lt;</span>target <span class="token assign-left variable">dev</span><span class="token operator">=</span><span class="token string">'vda'</span> <span class="token assign-left variable">bus</span><span class="token operator">=</span><span class="token string">'virtio'</span>/<span class="token operator">></span>
      <span class="token operator">&lt;</span>address <span class="token assign-left variable">type</span><span class="token operator">=</span><span class="token string">'pci'</span> <span class="token assign-left variable">domain</span><span class="token operator">=</span><span class="token string">'0x0000'</span> <span class="token assign-left variable">bus</span><span class="token operator">=</span><span class="token string">'0x04'</span> <span class="token assign-left variable">slot</span><span class="token operator">=</span><span class="token string">'0x00'</span> <span class="token assign-left variable">function</span><span class="token operator">=</span><span class="token string">'0x0'</span>/<span class="token operator">></span>
    <span class="token operator">&lt;</span>/disk<span class="token operator">></span>
<span class="token comment"># 导入配置文件</span>
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># virsh define /etc/libvirt/qemu/centos-share.xml </span>
<span class="token comment"># 开机</span>
<span class="token punctuation">[</span>root@kvm1 data<span class="token punctuation">]</span><span class="token comment"># virsh start centos-share</span>
Domain <span class="token string">'centos-share'</span> started
<span class="token comment"># 执行动态迁移</span>
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># virsh migrate --live --verbose --undefinesource --persistent centos-share qemu+ssh://kvm2/system</span>
Migration: <span class="token punctuation">[</span><span class="token number">100</span> %<span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="基于非共享存储迁移"><a href="#基于非共享存储迁移" class="headerlink" title="基于非共享存储迁移"></a>基于非共享存储迁移</h4><p>非共享存储的迁移功能基于NBD方式，NetworkBlockDevice，即让用户通过网络访问块设备、设备镜像的方式，通过流将磁盘数据发送到本地或者远程。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 添加防护的例外</span>
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># firewall-cmd --add-service=&#123;libvirt,libvirt-tls&#125; --permanent</span>
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># firewall-cmd --add-port=49152-49215/tcp --permanent</span>
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># firewall-cmd --reload</span>
<span class="token comment"># 添加域名解析</span>
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># cat /etc/hosts </span>
<span class="token number">127.0</span>.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
::1         localhost localhost.localdomain localhost6 localhost6.localdomain6
<span class="token number">192.168</span>.10.140	kvm1
<span class="token number">192.168</span>.10.141	kvm2
<span class="token number">192.168</span>.10.142	stor1

<span class="token comment"># 必须要添加--copy-storage-all参数才能复制镜像文件到非共享Host主机上</span>
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># virsh migrate --live  --copy-storage-all --verbose centos qemu+ssh://192.168.10.141/system </span>
Migration: <span class="token punctuation">[</span><span class="token number">100</span> %<span class="token punctuation">]</span>

<span class="token punctuation">[</span>root@kvm2 ~<span class="token punctuation">]</span><span class="token comment"># virsh list</span>
 Id   Name     State
------------------------
 <span class="token number">14</span>   centos   running<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="监控与优化"><a href="#监控与优化" class="headerlink" title="监控与优化"></a>监控与优化</h3><h4 id="Linux性能监控及调优工具"><a href="#Linux性能监控及调优工具" class="headerlink" title="Linux性能监控及调优工具"></a>Linux性能监控及调优工具</h4><p>主机性能的瓶颈要么由于错误或者非最优配置，要么业务负载重。对于前者血药调整配置，对于后者则需要扩容。而扩容有两种：</p>
<ul>
<li><p>纵向扩容：使用更多的内存、更好的CPU、更快的网络</p>
</li>
<li><p>横向扩容：使用更多的节点、组件来分担负载</p>
</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://brendangregg.com/linuxperf.html">Linux性能监控以及调优</a>的工具主要有：</p>
<ul>
<li><p>观测工具</p>
</li>
<li><p>静态性能分析工具</p>
</li>
<li><p>基准测试工具</p>
</li>
<li><p>调优工具</p>
</li>
<li><p>sar命令<br><img src="https://brendangregg.com/Perf/linux_observability_tools.png" alt="performanceTools"></p>
</li>
</ul>
<ol>
<li>top：显示Linux整体运行状态</li>
<li>ps：显示进程状态</li>
<li>uptime：显示系统运行时间</li>
<li>netstat：显示网络连接、路由表、接口统计信息</li>
<li>free：显示系统中可用和已用内存</li>
<li>vmstat：显示虚拟内存统计信息</li>
<li>sysctl：运行时配置内核参数</li>
<li>tcpdump：包分析工具</li>
<li>&#x2F;proc目录下的文件：系统信息</li>
<li>pgrep：根据名称和其他属性查找进程</li>
<li>ls* 命令：获得硬件信息，例如lscpu、lsblk、lsmem、lsscisi</li>
<li>tuned：针对不同业务需求快速调整系统参数</li>
</ol>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># lscpu</span>
Architecture:        x86_64
CPU op-mode<span class="token punctuation">(</span>s<span class="token punctuation">)</span>:      <span class="token number">32</span>-bit, <span class="token number">64</span>-bit
Byte Order:          Little Endian
CPU<span class="token punctuation">(</span>s<span class="token punctuation">)</span>:              <span class="token number">4</span>
On-line CPU<span class="token punctuation">(</span>s<span class="token punctuation">)</span> list: <span class="token number">0</span>-3
Thread<span class="token punctuation">(</span>s<span class="token punctuation">)</span> per core:  <span class="token number">1</span>
Core<span class="token punctuation">(</span>s<span class="token punctuation">)</span> per socket:  <span class="token number">4</span>
Socket<span class="token punctuation">(</span>s<span class="token punctuation">)</span>:           <span class="token number">1</span>
NUMA node<span class="token punctuation">(</span>s<span class="token punctuation">)</span>:        <span class="token number">1</span>
Vendor ID:           GenuineIntel
BIOS Vendor ID:      GenuineIntel
CPU family:          <span class="token number">6</span>
Model:               <span class="token number">158</span>
Model name:          Intel<span class="token punctuation">(</span>R<span class="token punctuation">)</span> Core<span class="token punctuation">(</span>TM<span class="token punctuation">)</span> i5-8300H CPU @ <span class="token number">2</span>.30GHz
BIOS Model name:     Intel<span class="token punctuation">(</span>R<span class="token punctuation">)</span> Core<span class="token punctuation">(</span>TM<span class="token punctuation">)</span> i5-8300H CPU @ <span class="token number">2</span>.30GHz
Stepping:            <span class="token number">10</span>
CPU MHz:             <span class="token number">2303.999</span>
BogoMIPS:            <span class="token number">4607.99</span>
Virtualization:      VT-x
Hypervisor vendor:   VMware
Virtualization type: full
L1d cache:           32K
L1i cache:           32K
L2 cache:            256K
L3 cache:            8192K
NUMA node0 CPU<span class="token punctuation">(</span>s<span class="token punctuation">)</span>:   <span class="token number">0</span>-3
Flags:               fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush mmx fxsr sse sse2 ss ht syscall nx pdpe1gb rdtscp lm constant_tsc arch_perfmon nopl xtopology tsc_reliable nonstop_tsc cpuid pni pclmulqdq vmx ssse3 fma cx16 pcid sse4_1 sse4_2 x2apic movbe popcnt tsc_deadline_timer aes xsave avx f16c rdrand hypervisor lahf_lm abm 3dnowprefetch cpuid_fault invpcid_single pti ssbd ibrs ibpb stibp tpr_shadow vnmi ept vpid ept_ad fsgsbase tsc_adjust bmi1 avx2 smep bmi2 invpcid rdseed adx smap clflushopt xsaveopt xsavec xgetbv1 xsaves arat md_clear flush_l1d arch_capabilities
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># lsmem</span>
RANGE                                 SIZE  STATE REMOVABLE BLOCK
0x0000000000000000-0x00000000bfffffff   3G online       <span class="token function">yes</span>  <span class="token number">0</span>-23
0x0000000100000000-0x000000023fffffff   5G online       <span class="token function">yes</span> <span class="token number">32</span>-71

Memory block size:       128M
Total online memory:       8G
Total offline memory:      0B
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># lsblk</span>
NAME              MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT
sda                 <span class="token number">8</span>:0    <span class="token number">0</span>   10G  <span class="token number">0</span> disk 
└─vg_data-lv_data <span class="token number">253</span>:2    <span class="token number">0</span>   10G  <span class="token number">0</span> lvm  
nvme0n1           <span class="token number">259</span>:0    <span class="token number">0</span>   20G  <span class="token number">0</span> disk 
├─nvme0n1p1       <span class="token number">259</span>:1    <span class="token number">0</span>  600M  <span class="token number">0</span> part /boot/efi
├─nvme0n1p2       <span class="token number">259</span>:2    <span class="token number">0</span>    1G  <span class="token number">0</span> part /boot
└─nvme0n1p3       <span class="token number">259</span>:3    <span class="token number">0</span> <span class="token number">18</span>.4G  <span class="token number">0</span> part 
  ├─rl_rocky-root <span class="token number">253</span>:0    <span class="token number">0</span> <span class="token number">16</span>.4G  <span class="token number">0</span> lvm  /
  └─rl_rocky-swap <span class="token number">253</span>:1    <span class="token number">0</span>    2G  <span class="token number">0</span> lvm  <span class="token punctuation">[</span>SWAP<span class="token punctuation">]</span>
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># lsscsi</span>
<span class="token punctuation">[</span><span class="token number">9</span>:0:0:0<span class="token punctuation">]</span>    disk    VMware,  VMware Virtual S <span class="token number">1.0</span>   /dev/sda 
<span class="token punctuation">[</span>N:0:0:1<span class="token punctuation">]</span>    disk    VMware Virtual NVMe Disk__1                /dev/nvme0n1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="使用Tuned优化性能"><a href="#使用Tuned优化性能" class="headerlink" title="使用Tuned优化性能"></a>使用Tuned优化性能</h4><p>Tuned可以根据不同业务需求和硬件条件，通过切换配置文件实现对需求的改变。针对虚拟化环境，有两个预安装的配置文件可以直接使用：</p>
<ol>
<li>virtual-host，用于宿主机，减少了虚拟内存交换，增加了磁盘预读值，并提供更积极的脏页回写</li>
<li>virtual-guest，用于运行在kvm上的虚机，减少了虚拟内存交换性，增加磁盘预读值，不会禁用disk barriers</li>
</ol>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 安装Tuned</span>
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># yum install -y tuned</span>
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># systemctl enable --now tuned</span>
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># tuned-adm active</span>
Current active profile: virtual-guest
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># tuned-adm list</span>
Available profiles:
- accelerator-performance     - Throughput performance based tuning with disabled higher latency STOP states
- aws                         - Optimize <span class="token keyword">for</span> aws ec2 instances
- balanced                    - General non-specialized tuned profile
- desktop                     - Optimize <span class="token keyword">for</span> the desktop use-case
- hpc-compute                 - Optimize <span class="token keyword">for</span> HPC compute workloads
- intel-sst                   - Configure <span class="token keyword">for</span> Intel Speed Select Base Frequency
- latency-performance         - Optimize <span class="token keyword">for</span> deterministic performance at the cost of increased power consumption
- network-latency             - Optimize <span class="token keyword">for</span> deterministic performance at the cost of increased power consumption, focused on low latency network performance
- network-throughput          - Optimize <span class="token keyword">for</span> streaming network throughput, generally only necessary on older CPUs or 40G+ networks
- optimize-serial-console     - Optimize <span class="token keyword">for</span> serial console use.
- powersave                   - Optimize <span class="token keyword">for</span> low power consumption
- throughput-performance      - Broadly applicable tuning that provides excellent performance across a variety of common server workloads
- virtual-guest               - Optimize <span class="token keyword">for</span> running inside a virtual guest
- virtual-host                - Optimize <span class="token keyword">for</span> running KVM guests
Current active profile: virtual-guest
<span class="token comment"># 激活配置文件</span>
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># tuned-adm profile aws</span>
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># tuned-adm active </span>
Current active profile: aws<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="VirtIO驱动"><a href="#VirtIO驱动" class="headerlink" title="VirtIO驱动"></a>VirtIO驱动</h4><p>VirtIO时一种半虚拟化框架。当使用该半虚拟化驱动程序时，虚拟机操作系统会认识到它在Hypervisor上运行，其IO请求不经过虚拟化层而直接发送给QEMU提供的半虚拟化设备，通过宿主机的驱动程序发送给真实的物理硬件，以提供较高的性能。</p>
<h4 id="CPU优化技术"><a href="#CPU优化技术" class="headerlink" title="CPU优化技术"></a>CPU优化技术</h4><p>宿主机逻辑CPU的数量时物理CPU的插槽(socket)，内核(core)和线程(thread)的乘积。</p>
<ul>
<li>vCPU的数量<ul>
<li>单个虚机的vCPU数量不能超过宿主机中逻辑CPU的总数</li>
<li>增加vCPU数量不一定能提高性能；</li>
<li>KVM支持CPU超分</li>
</ul>
</li>
<li>vCPU的配置<ul>
<li>“Copy host CPU configuration”是通用配置</li>
<li>“Hypervisor Default”是qemu64模式，可以让虚拟在物理CPU有差异的宿主机之间进行实时迁移</li>
</ul>
</li>
<li>vCPU的拓扑<ul>
<li>vCPU的拓扑是指设置vCPU的插槽、核心和线程数的不同比值</li>
<li>最佳策略根据需求确定所需插槽数，然后只分配一个内核和一个线程</li>
</ul>
</li>
</ul>
<h4 id="NUMA"><a href="#NUMA" class="headerlink" title="NUMA"></a>NUMA</h4><p>NUMA的出现是为了解决多CPU的协同工作和内存访问冲突的问题，CPU和内存都在相同NUMA节点内是最理想的配置。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 系统默认不安装</span>
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># yum install numactl</span>
<span class="token comment"># 查看NUMA情况，显示一个NUMA节点中有4个vcpu、8G内存</span>
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># numactl -H</span>
available: <span class="token number">1</span> nodes <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
<span class="token function">node</span> <span class="token number">0</span> cpus: <span class="token number">0</span> <span class="token number">1</span> <span class="token number">2</span> <span class="token number">3</span>
<span class="token function">node</span> <span class="token number">0</span> size: <span class="token number">7665</span> MB
<span class="token function">node</span> <span class="token number">0</span> free: <span class="token number">6783</span> MB
<span class="token function">node</span> distances:
<span class="token function">node</span>   <span class="token number">0</span> 
  <span class="token number">0</span>:  <span class="token number">10</span> 
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># virsh nodeinfo</span>
CPU model:           x86_64
CPU<span class="token punctuation">(</span>s<span class="token punctuation">)</span>:              <span class="token number">4</span>
CPU frequency:       <span class="token number">2303</span> MHz
CPU socket<span class="token punctuation">(</span>s<span class="token punctuation">)</span>:       <span class="token number">2</span>
Core<span class="token punctuation">(</span>s<span class="token punctuation">)</span> per socket:  <span class="token number">2</span>
Thread<span class="token punctuation">(</span>s<span class="token punctuation">)</span> per core:  <span class="token number">1</span>
NUMA cell<span class="token punctuation">(</span>s<span class="token punctuation">)</span>:        <span class="token number">1</span>
Memory size:         <span class="token number">7849944</span> KiB
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># virsh start centos7</span>
Domain <span class="token string">'centos7'</span> started
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># virsh vcpuinfo centos7</span>
VCPU:           <span class="token number">0</span>    <span class="token comment"># 表示虚机CPU0放置到宿主机CPU1上</span>
CPU:            <span class="token number">1</span>
State:          running
CPU time:       <span class="token number">11</span>.3s
CPU Affinity:   yyyy  <span class="token comment"># 表示可以放置到4个CPU上，一个y代表一个CPU</span>

VCPU:           <span class="token number">1</span>
CPU:            <span class="token number">2</span>
State:          running
CPU time:       <span class="token number">0</span>.1s
CPU Affinity:   yyyy
<span class="token comment"># 将虚机CPU固定到指定节点</span>
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># virsh edit centos7</span>
<span class="token comment"># 在下面一行之后新增CPU配置信息</span>
  <span class="token operator">&lt;</span>vcpu <span class="token assign-left variable">placement</span><span class="token operator">=</span><span class="token string">'static'</span><span class="token operator">></span><span class="token operator"><span class="token file-descriptor important">4</span>&lt;</span>/vcpu<span class="token operator">></span>
  <span class="token operator">&lt;</span>cputune<span class="token operator">></span>
    <span class="token operator">&lt;</span>vcpupin <span class="token assign-left variable">vcpu</span><span class="token operator">=</span><span class="token string">'0'</span> <span class="token assign-left variable">cpuset</span><span class="token operator">=</span><span class="token string">'3'</span>/<span class="token operator">></span>
    <span class="token operator">&lt;</span>vcpupin <span class="token assign-left variable">vcpu</span><span class="token operator">=</span><span class="token string">'1'</span> <span class="token assign-left variable">cpuset</span><span class="token operator">=</span><span class="token string">'2'</span>/<span class="token operator">></span>
    <span class="token operator">&lt;</span>vcpupin <span class="token assign-left variable">vcpu</span><span class="token operator">=</span><span class="token string">'2'</span> <span class="token assign-left variable">cpuset</span><span class="token operator">=</span><span class="token string">'1'</span>/<span class="token operator">></span>
    <span class="token operator">&lt;</span>vcpupin <span class="token assign-left variable">vcpu</span><span class="token operator">=</span><span class="token string">'3'</span> <span class="token assign-left variable">cpuset</span><span class="token operator">=</span><span class="token string">'0'</span>/<span class="token operator">></span>
  <span class="token operator">&lt;</span>/cputune<span class="token operator">></span>
<span class="token comment"># 然后重启centos7虚机，可见CPU固定节点</span>
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># virsh vcpuinfo centos7</span>
VCPU:           <span class="token number">0</span>
CPU:            <span class="token number">3</span>
State:          running
CPU time:       <span class="token number">14</span>.0s
CPU Affinity:   ---y

VCPU:           <span class="token number">1</span>
CPU:            <span class="token number">2</span>
State:          running
CPU time:       <span class="token number">2</span>.5s
CPU Affinity:   --y-

VCPU:           <span class="token number">2</span>
CPU:            <span class="token number">1</span>
State:          running
CPU time:       <span class="token number">2</span>.0s
CPU Affinity:   -y--

VCPU:           <span class="token number">3</span>
CPU:            <span class="token number">0</span>
State:          running
CPU time:       <span class="token number">2</span>.8s
CPU Affinity:   y---
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># virsh vcpupin centos7</span>
 VCPU   CPU Affinity
----------------------
 <span class="token number">0</span>      <span class="token number">3</span>
 <span class="token number">1</span>      <span class="token number">2</span>
 <span class="token number">2</span>      <span class="token number">1</span>
 <span class="token number">3</span>      <span class="token number">0</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在使用virt-install 部署虚机时，可以使用–cpuset来配置numa策略。</p>
<h4 id="内存优化"><a href="#内存优化" class="headerlink" title="内存优化"></a>内存优化</h4><p>内存分配主要考虑以下三个方面：</p>
<ol>
<li>内存分配</li>
<li>内存调整</li>
<li>内存支持</li>
</ol>
<p>优化KVM内存性能的第一条准则时不要向虚机分配过多内存。当物理机内存≤64GB时，虚机可用内存数为-2GB,当＞64GB时，可用内存数为内存总量-(2+5x内存总量&#x2F;64)。假设宿主机有32GB内存，则分配给虚机的内存总数为30GB；宿主机内存有256GB时，虚机可分配上限为：256-(2+0.5(256&#x2F;64))&#x3D;252GB.即内存不超过64GB时，为宿主机保留2GB内存；超过64GB，除了为宿主机保留2GB外，每组64GB内存应当预留512M。</p>
<p>内存气球是一种内存回收技术，可以在虚机运行时动态调整内存资源，而不需要关闭虚机。主流虚拟化解决方案都支持内存气泡，其中KVM通过virtiio_balloon设备实现。内存气泡只能由宿主机实现，可以通过充气操作增加气球设备所占用的虚机内存，从而将虚机空闲内存回收进行二次分配。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 启动虚机</span>
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># virsh start centos7</span>
Domain <span class="token string">'centos7'</span> started
<span class="token comment"># 宿主机可用内存6.5GB</span>
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># free -h</span>
              total        used        <span class="token function">free</span>      shared  buff/cache   available
Mem:          <span class="token number">7</span>.5Gi       358Mi       <span class="token number">6</span>.5Gi       <span class="token number">9</span>.0Mi       636Mi       <span class="token number">6</span>.9Gi
Swap:         <span class="token number">2</span>.0Gi          0B       <span class="token number">2</span>.0Gi
<span class="token comment"># 虚机开机正常后宿主机可用内存6.1GB</span>
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># free -h</span>
              total        used        <span class="token function">free</span>      shared  buff/cache   available
Mem:          <span class="token number">7</span>.5Gi       830Mi       <span class="token number">6</span>.1Gi       <span class="token number">9</span>.0Mi       571Mi       <span class="token number">6</span>.4Gi
Swap:         <span class="token number">2</span>.0Gi          0B       <span class="token number">2</span>.0Gi
<span class="token comment"># 查看虚机内存气泡情况，默认为配置的1GB</span>
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># virsh qemu-monitor-command centos7 --hmp --cmd info balloon</span>
balloon: <span class="token assign-left variable">actual</span><span class="token operator">=</span><span class="token number">1024</span>
<span class="token comment"># 对虚机进行充气100M内存的操作</span>
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># virsh qemu-monitor-command centos7 --hmp --cmd balloon 800</span>
<span class="token comment"># 虚机内存可用量降到800M</span>
<span class="token punctuation">[</span>root@guest ~<span class="token punctuation">]</span><span class="token comment"># free -h</span>
              total        used        <span class="token function">free</span>      shared  buff/cache   available
Mem:           766M        143M        522M        <span class="token number">6</span>.8M        100M        499M
Swap:          <span class="token number">1</span>.0G          0B        <span class="token number">1</span>.0G
<span class="token comment"># 再次充气，将虚机内存可用量将为256M</span>
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># virsh qemu-monitor-command centos7 --hmp --cmd balloon 256</span>
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># virsh qemu-monitor-command centos7 --hmp --cmd info balloon</span>
balloon: <span class="token assign-left variable">actual</span><span class="token operator">=</span><span class="token number">256</span>
<span class="token comment"># 虚机可用内存数量如下：</span>
<span class="token punctuation">[</span>root@guest ~<span class="token punctuation">]</span><span class="token comment"># free -h</span>
              total        used        <span class="token function">free</span>      shared  buff/cache   available
Mem:           222M        134M         60M        992K         27M        <span class="token number">3</span>.9M
Swap:          <span class="token number">1</span>.0G         11M        <span class="token number">1</span>.0G
<span class="token comment"># 执行放气操作，</span>
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># virsh qemu-monitor-command centos7 --hmp --cmd balloon 1024</span>
<span class="token comment"># 虚拟内存恢复默认值</span>
<span class="token punctuation">[</span>root@guest ~<span class="token punctuation">]</span><span class="token comment"># free -h</span>
              total        used        <span class="token function">free</span>      shared  buff/cache   available
Mem:           990M        134M        821M        976K         34M        768M
Swap:          <span class="token number">1</span>.0G         11M        <span class="token number">1</span>.0G<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="大页原理"><a href="#大页原理" class="headerlink" title="大页原理"></a>大页原理</h4><p>内存是以页(Page)为单位进行管理，x86架构通常为4KB，适用于大多数工作负载，而对于相对固定的大型内存占用程序而已，4KB内存页的性能开销较大。HugePage可以解决这个问题，通过提高内存页大小，减小了内页表项数节省了页表所占CPU缓存空间和内存地址转换次数，从而提高内存使用效率和性能。</p>
<p>大页的实现方式有两种哦：静态大页(Huge TLB)和动态大页(Transparent HugePages THP).</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># grep -i huge /proc/meminfo </span>
AnonHugePages:    <span class="token number">503808</span> kB
ShmemHugePages:        <span class="token number">0</span> kB
FileHugePages:         <span class="token number">0</span> kB
HugePages_Total:       <span class="token number">0</span>
HugePages_Free:        <span class="token number">0</span>
HugePages_Rsvd:        <span class="token number">0</span>
HugePages_Surp:        <span class="token number">0</span>
Hugepagesize:       <span class="token number">2048</span> kB
Hugetlb:               <span class="token number">0</span> kB<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="网络优化"><a href="#网络优化" class="headerlink" title="网络优化"></a>网络优化</h4><ul>
<li>需要合理隔离网络流量来避免网络拥塞，避免ARP Flux现象。</li>
</ul>
<pre class="line-numbers language-shelll" data-language="shelll"><code class="language-shelll">net.ipv4.conf.all.arp_filter&#x3D;1<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

<ul>
<li>使用vrtIO驱动和vhost模块来提供接近物理设备性能的驱动</li>
<li>使用桥接零复制传输提高宿主机大数据传输性能</li>
<li>多队列virtio-net</li>
<li>直接设备分配和SR-IOV</li>
<li>调整内核参数</li>
</ul>
<h4 id="存储优化"><a href="#存储优化" class="headerlink" title="存储优化"></a>存储优化</h4><ul>
<li>缓存模式：<ul>
<li>none：无页面缓存</li>
<li>writethrough：直写，数据直接落盘，使用宿主机缓存</li>
<li>writeback：回写，数据落宿主机之后即报告虚机完成写入</li>
<li>directsync：类似直写，但不经过缓存</li>
<li>unsafe：宿主机缓存所有IO</li>
</ul>
</li>
<li>I&#x2F;O模式</li>
<li>丢弃模式</li>
<li>检测零模式</li>
<li>I&#x2F;O调整<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 查看虚机的硬盘文件</span>
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># virsh domblklist centos7</span>
 Target   Source
-------------------------------------------------
 vda      /var/lib/libvirt/images/centos7.qcow2
 sda      -
<span class="token comment"># 限制硬盘iops值为100，读写吞吐量为10MB</span>
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># virsh blkdeviotune centos7 vda --total-iops-sec 100 --total-bytes-sec 10MB</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
</ul>
<h3 id="备份与还原"><a href="#备份与还原" class="headerlink" title="备份与还原"></a>备份与还原</h3><p>备份数据的目标是恢复数据。在恢复的过程中有2个最关键的衡量指标：</p>
<ul>
<li>RTO：Recovery Time Objective 指业务停止时长</li>
<li>RPO：Recovery Point Objectve 指可恢复时间点，即可恢复的数据代表的业务时长，也就是用户损失的数据量。</li>
</ul>
<p>备份的方法有两种：</p>
<ul>
<li>脱机备份：冷备</li>
<li>联机备份：热备</li>
</ul>
<h4 id="内部快照"><a href="#内部快照" class="headerlink" title="内部快照"></a>内部快照</h4><p>内部快照仅适用于QCOW2格式文件，它是磁盘快照和虚机内存状态的组合，所以也被称为检查点(Checkpoint)。KVM在创建快照的过程中，虚机会进入暂停模式，创建结束后会自动恢复运行，所以创建内部快照会导致系统中断。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 查看快照清单</span>
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># virsh snapshot-list centos7</span>
 Name   Creation Time   State
-------------------------------
<span class="token comment"># 创建名为snap1的快照</span>
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># virsh snapshot-create-as centos7 --name "snap1"</span>
Domain snapshot snap1 created
<span class="token comment"># 关机创建snap2的快照</span>
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># virsh shutdown centos7</span>
Domain <span class="token string">'centos7'</span> is being <span class="token function">shutdown</span>
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># virsh snapshot-create-as centos7 --name "snap2"</span>
Domain snapshot snap2 created
<span class="token comment"># 再次创建snap3的快照</span>
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># virsh start centos7</span>
Domain <span class="token string">'centos7'</span> started
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># virsh snapshot-create-as centos7 --name "snap3"</span>
Domain snapshot snap3 created
<span class="token comment"># 查看快照的层级</span>
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># virsh snapshot-list centos7 --parent</span>
 Name    Creation Time               State     Parent
-------------------------------------------------------
 snap1   <span class="token number">2023</span>-05-25 <span class="token number">17</span>:57:30 +0800   running   
 snap2   <span class="token number">2023</span>-05-25 <span class="token number">17</span>:59:43 +0800   shutoff   snap1
 snap3   <span class="token number">2023</span>-05-25 <span class="token number">18</span>:00:49 +0800   running   snap2
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># virsh snapshot-list centos7 --tree</span>
snap1
  <span class="token operator">|</span>
  +- snap2
      <span class="token operator">|</span>
      +- snap3
<span class="token comment"># 查看快照信息，可见snap1的快照占据287M空间，snap3快照占据321M空间，这些空间是内存的dump文件。</span>
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># qemu-img info /var/lib/libvirt/images/centos7.qcow2 </span>
image: /var/lib/libvirt/images/centos7.qcow2
<span class="token function">file</span> format: qcow2
virtual size: <span class="token number">10</span> GiB <span class="token punctuation">(</span><span class="token number">10737418240</span> bytes<span class="token punctuation">)</span>
disk size: <span class="token number">3.01</span> GiB
cluster_size: <span class="token number">65536</span>
Snapshot list:
ID        TAG               VM SIZE                DATE     VM CLOCK     ICOUNT
<span class="token number">1</span>         snap1             <span class="token number">287</span> MiB <span class="token number">2023</span>-05-25 <span class="token number">17</span>:57:30 03:31:24.541           
<span class="token number">2</span>         snap2                 <span class="token number">0</span> B <span class="token number">2023</span>-05-25 <span class="token number">17</span>:59:43 00:00:00.000          <span class="token number">0</span>
<span class="token number">3</span>         snap3             <span class="token number">321</span> MiB <span class="token number">2023</span>-05-25 <span class="token number">18</span>:00:49 00:00:45.355           
Format specific information:
    compat: <span class="token number">1.1</span>
    compression type: zlib
    lazy refcounts: <span class="token boolean">true</span>
    refcount bits: <span class="token number">16</span>
    corrupt: <span class="token boolean">false</span>
    extended l2: <span class="token boolean">false</span>
<span class="token comment"># 在虚机关机状态下恢复快照</span>
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># virsh snapshot-revert centos7 snap3</span>
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># virsh list</span>
 Id   Name      State
-------------------------
 <span class="token number">1</span>    centos7   running
<span class="token comment"># 在虚机运行情况下恢复关机状态的快照，并让虚机开机</span>
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># virsh snapshot-revert centos7 snap2 --running</span>
<span class="token comment"># 删除快照，直接删除父快照</span>
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># virsh snapshot-delete centos7 snap1</span>
Domain snapshot snap1 deleted
<span class="token comment"># 可见子快照升级为父快照</span>
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># virsh snapshot-list centos7 --tree</span>
snap2
  <span class="token operator">|</span>
  +- snap3
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># virsh snapshot-delete centos7 snap3</span>
Domain snapshot snap3 deleted
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># virsh snapshot-delete centos7 snap2</span>
Domain snapshot snap2 deleted
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># virsh snapshot-list centos7 --parent</span>
 Name   Creation Time   State   Parent
----------------------------------------<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="外部快照"><a href="#外部快照" class="headerlink" title="外部快照"></a>外部快照</h4><p>外部快照是指在外部保存快照资源，其中包括backing_file(后备文件)指虚机原始磁盘映像(只读)、overlay_image(覆盖映像)快照映像文件(可写)。创建外部快照之后，backing_file变为只读状态，数据写入overlay_image中。</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># 创建外部快照</span>
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># virsh snapshot-create-as centos7 snap1 "External Snapshot1" --disk-only --atomic</span>
Domain snapshot snap1 created
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># virsh snapshot-list </span>
error: <span class="token builtin class-name">command</span> <span class="token string">'snapshot-list'</span> requires <span class="token operator">&lt;</span>domain<span class="token operator">></span> option
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># virsh snapshot-list centos7</span>
 Name    Creation Time               State
----------------------------------------------------
 snap1   <span class="token number">2023</span>-05-25 <span class="token number">18</span>:18:31 +0800   disk-snapshot
<span class="token comment"># 快照位置为external</span>
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># virsh snapshot-info centos7 snap1 </span>
Name:           snap1
Domain:         centos7
Current:        <span class="token function">yes</span>
State:          disk-snapshot
Location:       external
Parent:         -
Children:       <span class="token number">0</span>
Descendants:    <span class="token number">0</span>
Metadata:       <span class="token function">yes</span>
<span class="token comment"># 虚机磁盘文件变更为.snap1文件</span>
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># virsh domblklist centos7</span>
 Target   Source
-------------------------------------------------
 vda      /var/lib/libvirt/images/centos7.snap1
 sda      -
<span class="token comment"># 原始镜像文件信息，2.41GB</span>
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># qemu-img info /var/lib/libvirt/images/centos7.qcow2 </span>
image: /var/lib/libvirt/images/centos7.qcow2
<span class="token function">file</span> format: qcow2
virtual size: <span class="token number">10</span> GiB <span class="token punctuation">(</span><span class="token number">10737418240</span> bytes<span class="token punctuation">)</span>
disk size: <span class="token number">2.41</span> GiB
<span class="token comment"># 快照盘文件信息，4.25M</span>
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># qemu-img info /var/lib/libvirt/images/centos7.snap1 </span>
image: /var/lib/libvirt/images/centos7.snap1
<span class="token function">file</span> format: qcow2
virtual size: <span class="token number">10</span> GiB <span class="token punctuation">(</span><span class="token number">10737418240</span> bytes<span class="token punctuation">)</span>
disk size: <span class="token number">4.25</span> MiB
<span class="token comment"># 原始镜像变为只读，所有数据写入则保留到新的snap1文件中。</span>
<span class="token comment"># 再次创建外部快照2</span>
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># virsh snapshot-create-as centos7 snap2 --disk-only --atomic</span>
Domain snapshot snap2 created
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># qemu-img info /var/lib/libvirt/images/centos7.snap</span>
centos7.snap1  centos7.snap2  
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># qemu-img info /var/lib/libvirt/images/centos7.snap2</span>
image: /var/lib/libvirt/images/centos7.snap2
<span class="token function">file</span> format: qcow2
virtual size: <span class="token number">10</span> GiB <span class="token punctuation">(</span><span class="token number">10737418240</span> bytes<span class="token punctuation">)</span>
disk size: <span class="token number">196</span> KiB
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># virsh snapshot-list centos7 --parent</span>
 Name    Creation Time               State           Parent
-------------------------------------------------------------
 snap1   <span class="token number">2023</span>-05-25 <span class="token number">18</span>:18:31 +0800   disk-snapshot   
 snap2   <span class="token number">2023</span>-05-25 <span class="token number">18</span>:25:30 +0800   shutoff         snap1

<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># virsh snapshot-list centos7 --tree</span>
snap1
  <span class="token operator">|</span>
  +- snap2
<span class="token comment"># 创建静默快照 --quiesce ，使开机状态的虚机在创建快照时将缓存文件同步写入磁盘</span>
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># virsh snapshot-create-as centos7 snap3 --disk-only --atomic --quiesce </span>
Domain snapshot snap3 created
<span class="token comment"># 快照链，从上到下展示快照数据的文件生成链</span>
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># qemu-img info --backing-chain /var/lib/libvirt/images/centos7.snap3</span>
image: /var/lib/libvirt/images/centos7.snap3
<span class="token function">file</span> format: qcow2
virtual size: <span class="token number">10</span> GiB <span class="token punctuation">(</span><span class="token number">10737418240</span> bytes<span class="token punctuation">)</span>
disk size: <span class="token number">8.44</span> MiB
cluster_size: <span class="token number">65536</span>
backing file: /var/lib/libvirt/images/centos7.snap2
backing <span class="token function">file</span> format: qcow2
Format specific information:
    compat: <span class="token number">1.1</span>
    compression type: zlib
    lazy refcounts: <span class="token boolean">false</span>
    refcount bits: <span class="token number">16</span>
    corrupt: <span class="token boolean">false</span>
    extended l2: <span class="token boolean">false</span>

image: /var/lib/libvirt/images/centos7.snap2
<span class="token function">file</span> format: qcow2
virtual size: <span class="token number">10</span> GiB <span class="token punctuation">(</span><span class="token number">10737418240</span> bytes<span class="token punctuation">)</span>
disk size: <span class="token number">196</span> KiB
cluster_size: <span class="token number">65536</span>
backing file: /var/lib/libvirt/images/centos7.snap1
backing <span class="token function">file</span> format: qcow2
Format specific information:
    compat: <span class="token number">1.1</span>
    compression type: zlib
    lazy refcounts: <span class="token boolean">false</span>
    refcount bits: <span class="token number">16</span>
    corrupt: <span class="token boolean">false</span>
    extended l2: <span class="token boolean">false</span>

image: /var/lib/libvirt/images/centos7.snap1
<span class="token function">file</span> format: qcow2
virtual size: <span class="token number">10</span> GiB <span class="token punctuation">(</span><span class="token number">10737418240</span> bytes<span class="token punctuation">)</span>
disk size: <span class="token number">2.5</span> MiB
cluster_size: <span class="token number">65536</span>
backing file: /var/lib/libvirt/images/centos7.qcow2
backing <span class="token function">file</span> format: qcow2
Format specific information:
    compat: <span class="token number">1.1</span>
    compression type: zlib
    lazy refcounts: <span class="token boolean">false</span>
    refcount bits: <span class="token number">16</span>
    corrupt: <span class="token boolean">false</span>
    extended l2: <span class="token boolean">false</span>

image: /var/lib/libvirt/images/centos7.qcow2
<span class="token function">file</span> format: qcow2
virtual size: <span class="token number">10</span> GiB <span class="token punctuation">(</span><span class="token number">10737418240</span> bytes<span class="token punctuation">)</span>
disk size: <span class="token number">2.41</span> GiB
cluster_size: <span class="token number">65536</span>
Format specific information:
    compat: <span class="token number">1.1</span>
    compression type: zlib
    lazy refcounts: <span class="token boolean">true</span>
    refcount bits: <span class="token number">16</span>
    corrupt: <span class="token boolean">false</span>
    extended l2: <span class="token boolean">false</span>
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># tree /var/lib/libvirt/qemu/snapshot/</span>
/var/lib/libvirt/qemu/snapshot/
└── centos7
    ├── snap1.xml
    ├── snap2.xml
    ├── snap3.xml
    └── snap4.xml
<span class="token comment"># 当前版本不支持外部快照恢复</span>
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># libvirtd --version</span>
libvirtd <span class="token punctuation">(</span>libvirt<span class="token punctuation">)</span> <span class="token number">8.0</span>.0
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># rpm -qi qemu-kvm |grep -i ^version</span>
Version     <span class="token builtin class-name">:</span> <span class="token number">6.2</span>.0
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># cat /etc/redhat-release </span>
Rocky Linux release <span class="token number">8.8</span> <span class="token punctuation">(</span>Green Obsidian<span class="token punctuation">)</span>
<span class="token punctuation">[</span>root@kvm1 ~<span class="token punctuation">]</span><span class="token comment"># virsh snapshot-revert centos7 snap2</span>
error: unsupported configuration: revert to external snapshot not supported yet
<span class="token comment"># 恢复外部快照只能修改手动配置文件和手动收缩磁盘。</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2>

	<div class="row">
    <embed src="https://cdn.sujx.net/documents/red_hat_enterprise_linux-8-configuring_and_managing_virtualization-zh-cn.pdf" width="100%" height="550" type="application/pdf">
	</div>






</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="https://www.sujx.net">靖轩</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://www.sujx.net/2022/11/03/How2UseKVM/">https://www.sujx.net/2022/11/03/How2UseKVM/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Virtual/">Virtual</a><a class="post-meta__tags" href="/tags/KVM/">KVM</a><a class="post-meta__tags" href="/tags/Linux/">Linux</a></div><div class="post_share"><div class="social-share" data-image="https://cdn.sujx.net/about/avatar.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2023/04/10/magedu-week-1/" title="Linux系统基础知识·1"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">Linux系统基础知识·1</div></div></a></div><div class="next-post pull-right"><a href="/2022/10/19/clean-old-kernel/" title="CentOS主机清理旧内核"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">CentOS主机清理旧内核</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://cdn.sujx.net/about/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">靖轩</div><div class="author-info__description">逝者如斯夫,不舍昼夜</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">94</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">179</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">13</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/sujx"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://gitee.com/grepsu" target="_blank" title="Gitee"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:sujx@live.cn" target="_blank" title="Email"><i class="fas fa-envelope"></i></a><a class="social-icon" href="/atom.xml" target="_blank" title="RSS链接"><i class="fa  fa-rss"></i></a></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A6%82%E5%BF%B5"><span class="toc-number">1.</span> <span class="toc-text">概念</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%A5%E9%97%A8"><span class="toc-number">2.</span> <span class="toc-text">入门</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E8%99%9A%E6%9C%BA"><span class="toc-number">2.1.</span> <span class="toc-text">创建虚机</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E5%AE%89%E8%A3%85"><span class="toc-number">2.1.1.</span> <span class="toc-text">准备安装</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BD%91%E9%A1%B5%E7%AB%AF%E9%83%A8%E7%BD%B2%E8%99%9A%E6%9C%BA"><span class="toc-number">2.1.2.</span> <span class="toc-text">网页端部署虚机</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%91%BD%E4%BB%A4%E8%A1%8C%E9%83%A8%E7%BD%B2%E8%99%9A%E6%9C%BA"><span class="toc-number">2.1.3.</span> <span class="toc-text">命令行部署虚机</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AE%A1%E7%90%86%E8%99%9A%E6%9C%BA"><span class="toc-number">2.2.</span> <span class="toc-text">管理虚机</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E7%A3%81%E7%9B%98%E6%96%87%E4%BB%B6"><span class="toc-number">2.2.1.</span> <span class="toc-text">创建磁盘文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A3%80%E6%9F%A5%E7%A3%81%E7%9B%98"><span class="toc-number">2.2.2.</span> <span class="toc-text">检查磁盘</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%A3%81%E7%9B%98%E9%A2%84%E5%88%86%E9%85%8D%E7%AD%96%E7%95%A5"><span class="toc-number">2.2.3.</span> <span class="toc-text">磁盘预分配策略</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%A3%81%E7%9B%98%E6%A0%BC%E5%BC%8F%E8%BD%AC%E6%8D%A2"><span class="toc-number">2.2.4.</span> <span class="toc-text">磁盘格式转换</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B0%83%E6%95%B4%E7%A3%81%E7%9B%98%E5%A4%A7%E5%B0%8F"><span class="toc-number">2.2.5.</span> <span class="toc-text">调整磁盘大小</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BF%AB%E7%85%A7%E7%AE%A1%E7%90%86"><span class="toc-number">2.2.6.</span> <span class="toc-text">快照管理</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AE%A1%E7%90%86%E7%BD%91%E7%BB%9C"><span class="toc-number">2.3.</span> <span class="toc-text">管理网络</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E9%BB%98%E8%AE%A4%E7%BD%91%E7%BB%9C%E7%8E%AF%E5%A2%83"><span class="toc-number">2.3.1.</span> <span class="toc-text">查看默认网络环境</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AE%BE%E5%A4%87%E7%B1%BB%E5%9E%8B%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86%E5%92%8C%E7%AE%A1%E7%90%86"><span class="toc-number">2.3.2.</span> <span class="toc-text">设备类型工作原理和管理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#KVM-x2F-libvirt%E5%B8%B8%E7%94%A8%E7%BD%91%E7%BB%9C%E7%B1%BB%E5%9E%8B"><span class="toc-number">2.3.3.</span> <span class="toc-text">KVM&#x2F;libvirt常用网络类型</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AE%A1%E7%90%86%E5%AD%98%E5%82%A8"><span class="toc-number">2.4.</span> <span class="toc-text">管理存储</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9C%AF%E8%AF%AD"><span class="toc-number">2.4.1.</span> <span class="toc-text">术语</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AD%98%E5%82%A8%E6%B1%A0"><span class="toc-number">2.4.2.</span> <span class="toc-text">存储池</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%A6%82%E5%BF%B5-1"><span class="toc-number">2.4.2.1.</span> <span class="toc-text">概念</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA"><span class="toc-number">2.4.2.2.</span> <span class="toc-text">创建</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AD%98%E5%82%A8%E5%8D%B7"><span class="toc-number">2.5.</span> <span class="toc-text">存储卷</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%9B%E9%98%B6"><span class="toc-number">3.</span> <span class="toc-text">进阶</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%99%9A%E6%9C%BA%E7%9A%84%E8%BF%81%E7%A7%BB"><span class="toc-number">3.1.</span> <span class="toc-text">虚机的迁移</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%BF%E4%B8%BB%E6%9C%BA%E5%86%85%E9%83%A8%E8%BF%81%E7%A7%BB"><span class="toc-number">3.1.1.</span> <span class="toc-text">宿主机内部迁移</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E%E5%85%B1%E4%BA%AB%E5%AD%98%E5%82%A8%E8%BF%81%E7%A7%BB"><span class="toc-number">3.1.2.</span> <span class="toc-text">基于共享存储迁移</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E%E9%9D%9E%E5%85%B1%E4%BA%AB%E5%AD%98%E5%82%A8%E8%BF%81%E7%A7%BB"><span class="toc-number">3.1.3.</span> <span class="toc-text">基于非共享存储迁移</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%91%E6%8E%A7%E4%B8%8E%E4%BC%98%E5%8C%96"><span class="toc-number">3.2.</span> <span class="toc-text">监控与优化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Linux%E6%80%A7%E8%83%BD%E7%9B%91%E6%8E%A7%E5%8F%8A%E8%B0%83%E4%BC%98%E5%B7%A5%E5%85%B7"><span class="toc-number">3.2.1.</span> <span class="toc-text">Linux性能监控及调优工具</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8Tuned%E4%BC%98%E5%8C%96%E6%80%A7%E8%83%BD"><span class="toc-number">3.2.2.</span> <span class="toc-text">使用Tuned优化性能</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#VirtIO%E9%A9%B1%E5%8A%A8"><span class="toc-number">3.2.3.</span> <span class="toc-text">VirtIO驱动</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#CPU%E4%BC%98%E5%8C%96%E6%8A%80%E6%9C%AF"><span class="toc-number">3.2.4.</span> <span class="toc-text">CPU优化技术</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#NUMA"><span class="toc-number">3.2.5.</span> <span class="toc-text">NUMA</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%86%85%E5%AD%98%E4%BC%98%E5%8C%96"><span class="toc-number">3.2.6.</span> <span class="toc-text">内存优化</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%A7%E9%A1%B5%E5%8E%9F%E7%90%86"><span class="toc-number">3.2.7.</span> <span class="toc-text">大页原理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BD%91%E7%BB%9C%E4%BC%98%E5%8C%96"><span class="toc-number">3.2.8.</span> <span class="toc-text">网络优化</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AD%98%E5%82%A8%E4%BC%98%E5%8C%96"><span class="toc-number">3.2.9.</span> <span class="toc-text">存储优化</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%87%E4%BB%BD%E4%B8%8E%E8%BF%98%E5%8E%9F"><span class="toc-number">3.3.</span> <span class="toc-text">备份与还原</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%86%85%E9%83%A8%E5%BF%AB%E7%85%A7"><span class="toc-number">3.3.1.</span> <span class="toc-text">内部快照</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%96%E9%83%A8%E5%BF%AB%E7%85%A7"><span class="toc-number">3.3.2.</span> <span class="toc-text">外部快照</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83"><span class="toc-number">4.</span> <span class="toc-text">参考</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/05/21/magedu-week-3/" title="Linux系统基础知识·3">Linux系统基础知识·3</a><time datetime="2023-05-21T14:48:47.000Z" title="Created 2023-05-21 22:48:47">2023-05-21</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/05/14/magedu-week-2/" title="Linux系统基础知识·2">Linux系统基础知识·2</a><time datetime="2023-05-14T14:48:47.000Z" title="Created 2023-05-14 22:48:47">2023-05-14</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023/04/10/magedu-week-1/" title="Linux系统基础知识·1">Linux系统基础知识·1</a><time datetime="2023-04-10T08:35:34.000Z" title="Created 2023-04-10 16:35:34">2023-04-10</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2022/11/03/How2UseKVM/" title="内核虚拟化KVM的使用">内核虚拟化KVM的使用</a><time datetime="2022-11-03T14:22:22.000Z" title="Created 2022-11-03 22:22:22">2022-11-03</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2022/10/19/clean-old-kernel/" title="CentOS主机清理旧内核">CentOS主机清理旧内核</a><time datetime="2022-10-19T06:48:47.000Z" title="Created 2022-10-19 14:48:47">2022-10-19</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('https://cdn.sujx.net/about/footimg.jpg')"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2023 By 靖轩</div><div class="footer_custom_text">京ICP备17034757号-1</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between single-column and double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">Search</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  Loading the Database</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts" type="text"/></div></div><hr/><div class="no-result" id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>